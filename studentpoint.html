<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>日语积分系统-动态姓名变色版</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <style>
        :root {
            --bg: #f0f2f5; --border: #d9d9d9;
            --hw-A: #237804; --hw-B: #73d13d; --hw-C: #fffb8f; --hw-D: #ffadd2; --hw-none: #f5222d;
            --dt-full: #237804; --dt-pass: #73d13d; --dt-re: #fadb14; --dt-fail: #f5222d;
            --att-1: #52c41a; --att-miss: #f5222d; --att-absent: #000000;
            /* 分数段颜色常量 */
            --rank-low: #000000;
            --rank-mid: #1890ff;
            --rank-high: #722ed1;
            --rank-top: #fa8c16;
        }
        * { box-sizing: border-box; font-family: -apple-system, system-ui, sans-serif; }
        body { margin: 0; padding: 10px; background: var(--bg); font-size: 11px; height: 100vh; display: flex; flex-direction: column; }
        
        #toolbar { display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 8px; }
        
        .table-container { flex: 1; overflow: auto; background: white; border: 1px solid var(--border); border-radius: 4px; }
        table { border-collapse: collapse; min-width: 1600px; width: 100%; table-layout: fixed; }
        th, td { border: 1px solid var(--border); text-align: center; height: 36px; padding: 0 2px; }
        th { background: #444; color: white; position: sticky; top: 0; z-index: 20; }

        .date-container { font-size: 10px; font-weight: normal; margin-top: 2px; color: #ffeb3b; }
        .date-input { font-size: 10px; border: none; border-radius: 2px; padding: 1px; width: 95%; cursor: pointer; }

        .sticky-class { position: sticky; left: 0; background: #f9f9f9 !important; z-index: 10; width: 50px; min-width: 50px; }
        
        /* 姓名列：初始颜色为黑色，通过 JS 动态修改 */
        .sticky-name { 
            position: sticky; 
            left: 50px; 
            background: #f9f9f9 !important; 
            z-index: 10; 
            width: 80px; 
            min-width: 80px; 
            border-right: 2px solid #888 !important; 
            text-decoration: underline; 
            cursor: pointer; 
            white-space: nowrap; 
            font-weight: bold;
            color: var(--rank-low); 
        }

        .btn-group { display: flex; justify-content: center; gap: 1px; width: 100%; }
        .opt { padding: 2px 0; border: 1px solid #ccc; cursor: pointer; background: #eee; border-radius: 2px; font-size: 9px; flex: 1; user-select: none; }
        [data-type="att"] .opt { font-size: 8px; max-width: 18px; }

        .week-sum { background: #f0f5ff !important; color: #ff4d4f !important; font-weight: 800; cursor: pointer; }
        .week-sum:hover { background: #d6e4ff !important; }

        .act-hw-A { background: var(--hw-A) !important; color: white; }
        .act-hw-B { background: var(--hw-B) !important; color: #000; }
        .act-hw-C { background: var(--hw-C) !important; color: #856404; }
        .act-hw-D { background: var(--hw-D) !important; color: #c41d7f; }
        .act-hw-未 { background: var(--hw-none) !important; color: white; }
        .act-dt-满 { background: var(--dt-full) !important; color: white; }
        .act-dt-过 { background: var(--dt-pass) !important; color: #000; }
        .act-dt-重 { background: var(--dt-re) !important; color: #856404; }
        .act-dt-未 { background: var(--dt-fail) !important; color: white; }
        .act-att-1 { background: var(--att-1) !important; color: white; }
        .act-att--1 { background: var(--att-miss) !important; color: white; }
        .act-att-缺 { background: var(--att-absent) !important; color: white; }

        .class-box { display: flex; align-items: center; justify-content: center; gap: 2px; }
        .score-val { font-weight: bold; width: 18px; color: #1890ff; font-size: 12px; }
        .day-sum { background: #fffdf0; font-weight: bold; }

        .modal { display:none; position:fixed; top:5%; left:5%; width:90%; height:90%; background:white; z-index:1000; padding:20px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.3); flex-direction:column; }
        .overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:900; }
        
        #compareScrollWrapper { width: 100%; flex: 1; overflow-x: auto; overflow-y: hidden; border: 1px solid #eee; background: #fafafa; border-radius: 8px; padding: 10px; }

        button.primary { background: #1890ff; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px; }
        button.danger { background: #f5222d; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="toolbar">
    <button class="primary" onclick="loadFromOSS()">从云端母版同步</button>
    <button class="primary" onclick="exportWeek()" style="background:#52c41a">导出彩色 Excel</button>
    <button class="primary" onclick="syncManual()" style="background:#faad14">手动同步数据</button>
    <div style="flex:1"></div>
    <button class="danger" onclick="clearAllRecords()">清空所有记录</button>
</div>

<div class="table-container">
    <table id="mainTable">
        <thead id="tHead"></thead>
        <tbody id="tBody"></tbody>
    </table>
</div>

<div class="overlay" id="ovl" onclick="closeAll()"></div>

<div id="compareModal" class="modal">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 style="margin:0">全班积分对比分析</h2>
        <div style="display:flex; gap:10px;">
            <button class="primary" id="sortBtn" onclick="toggleCompareSort()" style="background:#faad14">切换排序</button>
            <button class="primary" onclick="closeAll()" style="background:#ff4d4f">关闭窗口</button>
        </div>
    </div>
    <div id="compareScrollWrapper">
        <div id="compareInner" style="height: 100%; position: relative;">
            <canvas id="compareChart"></canvas>
        </div>
    </div>
</div>

<div id="radarModal" class="modal" style="width:500px; height:550px; left:50%; top:50%; transform:translate(-50%,-50%)">
    <h3 id="rTitle" style="text-align:center; margin-bottom: 5px;"></h3>
    <div style="width:420px; height:420px; margin: 0 auto;"><canvas id="radarChart"></canvas></div>
    <button class="primary" onclick="closeAll()" style="margin-top:10px; width:100%; background:#ff4d4f">关闭窗口</button>
</div>

<script>
const OSS_URL = "https://jp-game-assets-2026.oss-cn-chengdu.aliyuncs.com/学生积分自动化统计母版.xlsx";
const STORAGE_KEY = "JAPANESE_SYSTEM_DATA";
const SCORE_MAP = { hw: { 'A':3, 'B':2, 'C':1, 'D':-1, '未':-1 }, dt: { '满':3, '过':2, '重':1, '未':-1 }, att: { '1':1, '-1':-1, '缺':0 } };
const CLS_MAP = { hw: { 'A':'act-hw-A','B':'act-hw-B','C':'act-hw-C','D':'act-hw-D','未':'act-hw-未' }, dt: { '满':'act-dt-满','过':'act-dt-过','重':'act-dt-重','未':'act-dt-未' } };

let radarChart = null, compareChart = null;
let currentStudentList = [];
let isCompareSorted = false;

window.onload = async () => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
        const parsed = JSON.parse(saved);
        currentStudentList = parsed.students;
        initTable(currentStudentList, parsed.records, parsed.monday);
    } else { loadFromOSS(); }
};

async function loadFromOSS() {
    try {
        const res = await fetch(OSS_URL);
        const arrayBuffer = await res.arrayBuffer();
        const workbook = XLSX.read(new Uint8Array(arrayBuffer), {type:'array'});
        const raw = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header:1});
        currentStudentList = raw.slice(3).filter(r => r[1]).map(r => ({ class: r[0], name: r[1] }));
        initTable(currentStudentList);
    } catch (err) { alert("云端加载失败"); }
}

function initTable(students, records = {}, monday = "") {
    const head = document.getElementById('tHead'), body = document.getElementById('tBody');
    body.innerHTML = "";
    let dayHeaders = "";
    ['周一','周二','周三','周四','周五'].forEach((day, idx) => {
        let dateHtml = idx === 0 ? `<div class="date-container"><input type="date" class="date-input" id="mondayDate" value="${monday}" onchange="updateWeekDates(this.value)"></div>` : `<div class="date-container" id="date-label-${idx}">-- / --</div>`;
        dayHeaders += `<th colspan="5" style="border-left:2px solid #fff; height: 50px;">${day}${dateHtml}</th>`;
    });
    head.innerHTML = `<tr><th rowspan="2" class="sticky-class">班级</th><th rowspan="2" class="sticky-name">姓名</th>${dayHeaders}<th rowspan="2" class="week-sum" onclick="showWeeklyComparison()">周合计</th></tr><tr>${Array(5).fill('<th>出</th><th>作</th><th>听</th><th>课</th><th class="day-sum">∑</th>').join('')}</tr>`;
    students.forEach((stu, sIdx) => {
        const tr = document.createElement('tr'); 
        tr.dataset.sidx = sIdx; tr.dataset.name = stu.name; tr.dataset.class = stu.class;
        let cells = `<td class="sticky-class">${stu.class||''}</td><td class="sticky-name" onclick="showRadar(${sIdx})">${stu.name}</td>`;
        for(let d=0; d<5; d++) {
            const rec = records[stu.name]?.[d] || { att:'', hw:'', dt:'', cls:0 };
            cells += `<td><div class="btn-group" data-type="att" data-day="${d}"><span class="opt ${rec.att=='1'?'act-att-1':''}" data-val="1">1</span><span class="opt ${rec.att=='-1'?'act-att--1':''}" data-val="-1">-1</span><span class="opt ${rec.att=='缺'?'act-att-缺':''}" data-val="缺">缺</span></div></td><td><div class="btn-group" data-type="hw" data-day="${d}">${['A','B','C','D','未'].map(v => `<span class="opt ${rec.hw==v?CLS_MAP.hw[v]:''}" data-val="${v}">${v==='未'?'×':v}</span>`).join('')}</div></td><td><div class="btn-group" data-type="dt" data-day="${d}">${['满','过','重','未'].map(v => `<span class="opt ${rec.dt==v?CLS_MAP.dt[v]:''}" data-val="${v}">${v}</span>`).join('')}</div></td><td><div class="class-box" data-day="${d}"><button onclick="updCls(this,-1)">-</button><span class="score-val">${rec.cls}</span><button onclick="updCls(this,1)">+</button></div></td><td class="day-sum" id="sum-${sIdx}-${d}">0</td>`;
        }
        cells += `<td class="week-sum" id="total-${sIdx}" onclick="showWeeklyComparison()">0</td>`;
        tr.innerHTML = cells; body.appendChild(tr); calcScore(tr, sIdx);
    });
    if(monday) updateWeekDates(monday);
}

/**
 * 重点：计算得分并同步更新姓名颜色
 */
function calcScore(tr, sIdx) {
    let weekSum = 0;
    for(let d=0; d<5; d++) {
        let dSum = 0;
        ['att','hw','dt'].forEach(t => {
            const act = tr.querySelector(`[data-type="${t}"][data-day="${d}"] .opt[class*="act-"]`);
            if(act) dSum += (t === 'att' ? SCORE_MAP.att[act.dataset.val] : SCORE_MAP[t][act.dataset.val]);
        });
        dSum += parseInt(tr.querySelector(`.class-box[data-day="${d}"] .score-val`).innerText);
        const daySumEl = document.getElementById(`sum-${sIdx}-${d}`);
        if(daySumEl) daySumEl.innerText = dSum;
        weekSum += dSum;
    }
    const totalEl = document.getElementById(`total-${sIdx}`);
    if(totalEl) totalEl.innerText = weekSum;

    // 需求：姓名颜色根据总分区间变化
    const nameEl = tr.querySelector('.sticky-name');
    if(nameEl) {
        if (weekSum >= 40) nameEl.style.color = '#fa8c16';      // 橙色
        else if (weekSum >= 30) nameEl.style.color = '#722ed1'; // 紫色
        else if (weekSum >= 20) nameEl.style.color = '#1890ff'; // 天蓝色
        else nameEl.style.color = '#000000';                   // 黑色
    }
}

function exportWeek() {
    const monday = document.getElementById('mondayDate').value;
    const s_header = { fill: { fgColor: { rgb: "444444" } }, font: { color: { rgb: "FFFFFF" }, bold: true }, alignment: { horizontal: "center" }, border: { top: {style:"thin"}, bottom: {style:"thin"}, left: {style:"thin"}, right: {style:"thin"} } };
    const s_neg = { fill: { fgColor: { rgb: "FFC7CE" } }, font: { color: { rgb: "9C0006" } }, alignment: { horizontal: "center" } };
    const s_pos = { fill: { fgColor: { rgb: "C6EFCE" } }, font: { color: { rgb: "006100" } }, alignment: { horizontal: "center" } };
    const s_def = { alignment: { horizontal: "center" } };
    const s_absent = { fill: { fgColor: { rgb: "D9D9D9" } }, alignment: { horizontal: "center" } };

    const header1 = ["班级", "姓名", "周一", "", "", "", "", "周二", "", "", "", "", "周三", "", "", "", "", "周四", "", "", "", "", "周五", "", "", "", "", "总计"];
    const header2 = ["", "", "出勤", "作业", "听写", "课堂", "当日∑", "出勤", "作业", "听写", "课堂", "当日∑", "出勤", "作业", "听写", "课堂", "当日∑", "出勤", "作业", "听写", "课堂", "当日∑", "出勤", "作业", "听写", "课堂", "当日∑", ""];
    
    const rows = [];
    document.querySelectorAll('#tBody tr').forEach(tr => {
        const row = [ { v: tr.dataset.class, s: s_def }, { v: tr.dataset.name, s: s_def } ];
        for(let d=0; d<5; d++) {
            const att = tr.querySelector(`[data-type="att"][data-day="${d}"] .opt[class*="act-"]`)?.dataset.val || "";
            const hw = tr.querySelector(`[data-type="hw"][data-day="${d}"] .opt[class*="act-"]`)?.dataset.val || "";
            const dt = tr.querySelector(`[data-type="dt"][data-day="${d}"] .opt[class*="act-"]`)?.dataset.val || "";
            const cls = tr.querySelector(`.class-box[data-day="${d}"] .score-val`).innerText;
            const sum = tr.querySelector(`#sum-${tr.dataset.sidx}-${d}`).innerText;
            row.push(
                { v: att, s: att=='-1' ? s_neg : (att=='1' ? s_pos : (att=='缺' ? s_absent : s_def)) },
                { v: hw, s: (hw=='D'||hw=='未') ? s_neg : (['A','B'].includes(hw) ? s_pos : s_def) },
                { v: dt, s: dt=='未' ? s_neg : (['满','过'].includes(dt) ? s_pos : s_def) },
                { v: parseInt(cls), s: s_def }, { v: parseInt(sum), s: s_def }
            );
        }
        row.push({ v: parseInt(tr.querySelector('.week-sum').innerText), s: { font: { bold: true, color:{rgb:"FF0000"} }, alignment:{horizontal:"center"} } });
        rows.push(row);
    });

    const ws = XLSX.utils.aoa_to_sheet([
        [{ v: `日语积分周报 (${monday||'未日期'})`, s: { font: { bold: true, size: 14 } } }],
        header1.map(h => ({ v: h, s: s_header })), header2.map(h => ({ v: h, s: s_header })), ...rows
    ]);
    ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 27 } }, ...[0, 1, 2, 3, 4].map(i => ({ s: { r: 1, c: 2 + i * 5 }, e: { r: 1, c: 6 + i * 5 } })) ];
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "周报");
    XLSX.writeFile(wb, `彩色周报_${monday||new Date().getTime()}.xlsx`);
}

function showWeeklyComparison() {
    let dataSet = [];
    document.querySelectorAll('#tBody tr').forEach(tr => {
        dataSet.push({ name: tr.dataset.name, total: parseInt(tr.querySelector('.week-sum').innerText) });
    });
    if(isCompareSorted) dataSet.sort((a, b) => b.total - a.total);
    const names = dataSet.map(d => d.name), totals = dataSet.map(d => d.total);
    document.getElementById('ovl').style.display = 'block'; document.getElementById('compareModal').style.display = 'flex';
    const dynamicWidth = Math.max(document.getElementById('compareScrollWrapper').clientWidth - 20, names.length * 45);
    document.getElementById('compareInner').style.width = dynamicWidth + 'px';
    const ctx = document.getElementById('compareChart').getContext('2d');
    if(compareChart) compareChart.destroy();
    compareChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: names,
            datasets: [{
                label: '本周得分', data: totals,
                backgroundColor: totals.map(v => {
                    if (v >= 40) return '#fa8c16'; if (v >= 30) return '#722ed1'; if (v >= 20) return '#1890ff'; return '#8c8c8c'; 
                }), borderRadius: 4
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
    });
}

function toggleCompareSort() { isCompareSorted = !isCompareSorted; document.getElementById('sortBtn').innerText = isCompareSorted ? "排序：按分数" : "排序：按名单"; showWeeklyComparison(); }

function updateWeekDates(v) {
    if(!v) return; const m = new Date(v);
    for(let i=1; i<5; i++) {
        const t = new Date(m); t.setDate(m.getDate()+i);
        const l = document.getElementById(`date-label-${i}`);
        if(l) l.innerText = `${(t.getMonth()+1).toString().padStart(2,'0')} / ${t.getDate().toString().padStart(2,'0')}`;
    }
    autoSave();
}

function autoSave() {
    const recs = {};
    document.querySelectorAll('#tBody tr').forEach(tr => {
        const n = tr.dataset.name; recs[n] = {};
        for(let d=0; d<5; d++) {
            recs[n][d] = {
                att: tr.querySelector(`[data-type="att"][data-day="${d}"] .opt[class*="act-"]`)?.dataset.val || '',
                hw: tr.querySelector(`[data-type="hw"][data-day="${d}"] .opt[class*="act-"]`)?.dataset.val || '',
                dt: tr.querySelector(`[data-type="dt"][data-day="${d}"] .opt[class*="act-"]`)?.dataset.val || '',
                cls: parseInt(tr.querySelector(`.class-box[data-day="${d}"] .score-val`).innerText)
            };
        }
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ students:currentStudentList, records:recs, monday:document.getElementById('mondayDate')?.value||'' }));
}

document.body.addEventListener('click', e => {
    if(!e.target.classList.contains('opt')) return;
    const opt = e.target, p = opt.parentElement, type = p.dataset.type, val = opt.dataset.val, tr = opt.closest('tr');
    let tCls = type==='att' ? `act-att-${val}` : CLS_MAP[type][val];
    const isA = opt.classList.contains(tCls);
    Array.from(p.children).forEach(o => { const c = Array.from(o.classList).find(x => x.startsWith('act-')); if(c) o.classList.remove(c); });
    if(!isA) opt.classList.add(tCls);
    calcScore(tr, tr.dataset.sidx); autoSave();
});

function updCls(btn, delta) {
    const span = btn.parentElement.querySelector('.score-val'), tr = btn.closest('tr');
    span.innerText = parseInt(span.innerText) + delta;
    calcScore(tr, tr.dataset.sidx); autoSave();
}

function showRadar(sIdx) {
    const tr = document.querySelector(`tr[data-sidx="${sIdx}"]`), name = tr.dataset.name;
    let s = { att:0, hw:0, dt:0, cls:0 };
    for(let d=0; d<5; d++) {
        const a = tr.querySelector(`[data-type="att"][data-day="${d}"] .opt[class*="act-"]`); if(a) s.att += SCORE_MAP.att[a.dataset.val];
        const h = tr.querySelector(`[data-type="hw"][data-day="${d}"] .opt[class*="act-"]`); if(h) s.hw += SCORE_MAP.hw[h.dataset.val];
        const dt = tr.querySelector(`[data-type="dt"][data-day="${d}"] .opt[class*="act-"]`); if(dt) s.dt += SCORE_MAP.dt[dt.dataset.val];
        s.cls += parseInt(tr.querySelector(`.class-box[data-day="${d}"] .score-val`).innerText);
    }
    const norm = (v, t) => {
        if (t === 'att') return (v/5)*100; if (t === 'hw' || t === 'dt') return (v/15)*100;
        if (t === 'cls') { if(v<=0) return (v/10)*100; if(v<=5) return (v/5)*66.6; return 66.6+((v-5)/5)*33.4; }
        return v;
    };
    document.getElementById('ovl').style.display = 'block'; document.getElementById('radarModal').style.display = 'block';
    document.getElementById('rTitle').innerText = `${name} 周能力雷达 (${s.att+s.hw+s.dt+s.cls})`;
    if(radarChart) radarChart.destroy();
    radarChart = new Chart(document.getElementById('radarChart'), {
        type: 'radar',
        data: {
            labels: [`出勤(${s.att})`,`作业(${s.hw})`,`听写(${s.dt})`,`课堂(${s.cls})`],
            datasets: [{ data:[norm(s.att,'att'),norm(s.hw,'hw'),norm(s.dt,'dt'),norm(s.cls,'cls')], backgroundColor:'rgba(24,144,255,0.2)', borderColor:'#1890ff' }]
        },
        options: { scales: { r: { min:-20, max:100, ticks:{display:false} } } }
    });
}

function closeAll() { document.querySelectorAll('.modal, .overlay').forEach(el => el.style.display='none'); }
function clearAllRecords() { if(confirm("清除所有记录吗？")) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }
function syncManual() {
    const act = prompt("EXPORT 导出，IMPORT 导入");
    if(act==='EXPORT') { alert(localStorage.getItem(STORAGE_KEY)); }
    else if(act==='IMPORT') { const c = prompt("粘贴同步代码"); if(c){localStorage.setItem(STORAGE_KEY, c); location.reload();} }
}
</script>
</body>
</html>