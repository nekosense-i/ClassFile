<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ—¥è¯­ç§¯åˆ†ç³»ç»Ÿ-å…¨åŠŸèƒ½ç»ˆæç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <style>
        :root {
            --bg: #f0f2f5; --border: #d9d9d9;
            --hw-A: #237804; --hw-B: #73d13d; --hw-C: #fffb8f; --hw-D: #ffadd2; --hw-none: #f5222d;
            --dt-full: #237804; --dt-pass: #73d13d; --dt-re: #fadb14; --dt-fail: #f5222d;
            --att-1: #52c41a; --att-miss: #f5222d; --att-absent: #000000;
            --rank-low: #000000; --rank-mid: #1890ff; --rank-high: #722ed1; --rank-top: #fa8c16;
        }
        * { box-sizing: border-box; font-family: -apple-system, system-ui, sans-serif; }
        body { margin: 0; padding: 10px; background: var(--bg); font-size: 11px; height: 100vh; display: flex; flex-direction: column; }
        
        #toolbar { display: flex; align-items: center; gap: 8px; padding: 10px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 8px; flex-wrap: wrap; }
        
        .table-container { flex: 1; overflow: auto; background: white; border: 1px solid var(--border); border-radius: 4px; }
        table { border-collapse: collapse; min-width: 1600px; width: 100%; table-layout: fixed; }
        th, td { border: 1px solid var(--border); text-align: center; height: 38px; padding: 0 2px; }
        th { background: #444; color: white; position: sticky; top: 0; z-index: 20; }

        .date-container { font-size: 10px; font-weight: normal; margin-top: 2px; color: #ffeb3b; }
        .date-input { font-size: 10px; border: none; border-radius: 2px; padding: 1px; width: 95%; cursor: pointer; }

        .sticky-class { position: sticky; left: 0; background: #f9f9f9 !important; z-index: 10; width: 50px; min-width: 50px; }
        .sticky-name { position: sticky; left: 50px; background: #f9f9f9 !important; z-index: 10; width: 80px; min-width: 80px; border-right: 2px solid #888 !important; text-decoration: underline; cursor: pointer; white-space: nowrap; font-weight: bold; }

        .btn-group { display: flex; justify-content: center; gap: 1px; width: 100%; }
        .opt { padding: 2px 0; border: 1px solid #ccc; cursor: pointer; background: #eee; border-radius: 2px; font-size: 9px; flex: 1; user-select: none; }
        [data-type="att"] .opt { font-size: 8px; max-width: 18px; }

        .week-sum { background: #f0f5ff !important; color: #ff4d4f !important; font-weight: 800; cursor: pointer; }

        /* iPad é€‚é…æŒ‰é’®ä¼˜åŒ– */
        .class-box { display: flex; align-items: center; justify-content: center; gap: 1px; width: 100%; }
        .class-box button { width: 18px; height: 18px; padding: 0; border: 1px solid #ccc; background: #fff; border-radius: 3px; flex-shrink: 0;appearance: none; }
        .score-val { font-weight: bold; width: 16px; color: #1890ff; font-size: 11px; text-align: center; }
        .day-sum { background: #fffdf0; font-weight: bold; }

        /* å¼¹çª—é€šç”¨æ ·å¼ */
        .modal { display:none; position:fixed; top:5%; left:5%; width:90%; height:90%; background:white; z-index:1000; padding:20px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.3); flex-direction:column; }
        .overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:900; }
        #compareScrollWrapper { width: 100%; flex: 1; overflow-x: auto; overflow-y: hidden; border: 1px solid #eee; background: #fafafa; border-radius: 8px; padding: 10px; }
        
        #monthList table { min-width: 100%; table-layout: auto; }
        #monthList th { background: #f0f2f5; color: #333; position: static; }

        button.primary { background: #1890ff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px; }
        button.danger { background: #f5222d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* æ¿€æ´»çŠ¶æ€é¢œè‰² */
        .act-hw-A { background: var(--hw-A) !important; color: white; }
        .act-hw-B { background: var(--hw-B) !important; color: #000; }
        .act-hw-C { background: var(--hw-C) !important; color: #856404; }
        .act-hw-D { background: var(--hw-D) !important; color: #c41d7f; }
        .act-hw-æœª { background: var(--hw-none) !important; color: white; }
        .act-dt-æ»¡ { background: var(--dt-full) !important; color: white; }
        .act-dt-è¿‡ { background: var(--dt-pass) !important; color: #000; }
        .act-dt-é‡ { background: var(--dt-re) !important; color: #856404; }
        .act-dt-æœª { background: var(--dt-fail) !important; color: white; }
        .act-att-1 { background: var(--att-1) !important; color: white; }
        .act-att--1 { background: var(--att-miss) !important; color: white; }
        .act-att-ç¼º { background: var(--att-absent) !important; color: white; }
    </style>
</head>
<body>

<div id="toolbar">
    <button class="primary" onclick="loadFromOSS()">â˜ï¸ åŒæ­¥äº‘æ¯ç‰ˆ</button>
    <button class="primary" onclick="exportWeek()" style="background:#52c41a">ğŸ“¤ å¯¼å‡ºå½©è‰²å‘¨æŠ¥</button>
    <button class="primary" onclick="openMonth()" style="background:#722ed1">ğŸ“… æœˆåº¦æˆé•¿åˆ†æ</button>
    <button class="primary" onclick="syncManual()" style="background:#faad14">ğŸ”„ æ‰‹åŠ¨åŒæ­¥</button>
    <div style="flex:1"></div>
    <button class="danger" onclick="clearAllRecords()">ğŸ—‘ï¸ æ¸…ç©ºå½“å‰è®°å½•</button>
</div>

<div class="table-container">
    <table id="mainTable">
        <thead id="tHead"></thead>
        <tbody id="tBody"></tbody>
    </table>
</div>

<div class="overlay" id="ovl" onclick="closeAll()"></div>

<div id="monthModal" class="modal">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center">
        <h2>æœˆåº¦æˆé•¿è¶‹åŠ¿åˆ†æ</h2>
        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('multiIn').click()" class="primary" style="background:#13c2c2">+ æ‰¹é‡å¯¼å…¥å‘¨æŠ¥</button>
            <input type="file" id="multiIn" multiple accept=".xlsx" style="display:none" onchange="calcMonth(this.files)"/>
            <button onclick="exportMonth()" class="primary" style="background:#faad14">å¯¼å‡ºæœˆåº¦æ±‡æ€»</button>
            <button onclick="closeAll()" class="primary" style="background:#ff4d4f">å…³é—­</button>
        </div>
    </div>
    <div style="height:320px; width:100%; border-bottom:1px solid #eee; margin-bottom:10px;"><canvas id="monthChart"></canvas></div>
    <div id="monthList" style="flex:1; overflow:auto"></div>
</div>

<div id="compareModal" class="modal">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 style="margin:0">å…¨ç­å¯¹æ¯”</h2>
        <div style="display:flex; gap:10px;">
            <button class="primary" id="sortBtn" onclick="toggleCompareSort()" style="background:#faad14">åˆ‡æ¢æ’åº</button>
            <button class="primary" onclick="closeAll()" style="background:#ff4d4f">å…³é—­</button>
        </div>
    </div>
    <div id="compareScrollWrapper"><div id="compareInner" style="height: 100%; position: relative;"><canvas id="compareChart"></canvas></div></div>
</div>

<div id="radarModal" class="modal" style="width:500px; height:550px; left:50%; top:50%; transform:translate(-50%,-50%)">
    <h3 id="rTitle" style="text-align:center; margin-bottom: 5px;"></h3>
    <div style="width:400px; height:400px; margin: 0 auto;"><canvas id="radarChart"></canvas></div>
    <button class="primary" onclick="closeAll()" style="margin-top:10px; width:100%; background:#ff4d4f">å…³é—­</button>
</div>

<script>
// --- é…ç½®ä¸å˜é‡ ---
const OSS_URL = "https://jp-game-assets-2026.oss-cn-chengdu.aliyuncs.com/å­¦ç”Ÿåå•æ¨¡æ¿/ss-gakupo-25B.xlsx";
const STORAGE_KEY = "JAPANESE_SYSTEM_DATA";
const SCORE_MAP = { hw: { 'A':3, 'B':2, 'C':1, 'D':-1, 'æœª':-1 }, dt: { 'æ»¡':3, 'è¿‡':2, 'é‡':1, 'æœª':-1 }, att: { '1':1, '-1':-1, 'ç¼º':0 } };
const CLS_MAP = { hw: { 'A':'act-hw-A','B':'act-hw-B','C':'act-hw-C','D':'act-hw-D','æœª':'act-hw-æœª' }, dt: { 'æ»¡':'act-dt-æ»¡','è¿‡':'act-dt-è¿‡','é‡':'act-dt-é‡','æœª':'act-dt-æœª' } };

let radarChart = null, compareChart = null, monthChart = null;
let currentStudentList = [];
let isCompareSorted = false;
let monthData = {}; // å­˜å‚¨åˆå¹¶åçš„æœˆåº¦æ•°æ®

// --- åˆå§‹åŒ–ä¸äº‘ç«¯åŒæ­¥ ---
window.onload = async () => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
        const parsed = JSON.parse(saved);
        currentStudentList = parsed.students;
        initTable(currentStudentList, parsed.records, parsed.monday);
    } else { loadFromOSS(); }
};

async function loadFromOSS() {
    try {
        const res = await fetch(OSS_URL);
        const arrayBuffer = await res.arrayBuffer();
        const workbook = XLSX.read(new Uint8Array(arrayBuffer), {type:'array'});
        const raw = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header:1});
        currentStudentList = raw.slice(3).filter(r => r[1]).map(r => ({ class: r[0], name: r[1] }));
        initTable(currentStudentList);
    } catch (err) { alert("äº‘ç«¯æ‹‰å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ OSS CORS è®¾ç½®"); }
}

function initTable(students, records = {}, monday = "") {
    const head = document.getElementById('tHead'), body = document.getElementById('tBody');
    body.innerHTML = "";
    let dayHeaders = "";
    ['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”'].forEach((day, idx) => {
        let dateHtml = idx === 0 ? `<div class="date-container"><input type="date" class="date-input" id="mondayDate" value="${monday}" onchange="updateWeekDates(this.value)"></div>` : `<div class="date-container" id="date-label-${idx}">-- / --</div>`;
        dayHeaders += `<th colspan="5" style="border-left:2px solid #fff; height: 50px;">${day}${dateHtml}</th>`;
    });
    head.innerHTML = `<tr><th rowspan="2" class="sticky-class">ç­çº§</th><th rowspan="2" class="sticky-name">å§“å</th>${dayHeaders}<th rowspan="2" class="week-sum" onclick="showWeeklyComparison()">å‘¨åˆè®¡</th></tr><tr>${Array(5).fill('<th>å‡º</th><th>ä½œ</th><th>å¬</th><th>è¯¾</th><th class="day-sum">âˆ‘</th>').join('')}</tr>`;
    
    students.forEach((stu, sIdx) => {
        const tr = document.createElement('tr'); 
        tr.dataset.sidx = sIdx; tr.dataset.name = stu.name; tr.dataset.class = stu.class;
        let cells = `<td class="sticky-class">${stu.class||''}</td><td class="sticky-name" onclick="showRadar(${sIdx})">${stu.name}</td>`;
        for(let d=0; d<5; d++) {
            const rec = records[stu.name]?.[d] || { att:'', hw:'', dt:'', cls:0 };
            cells += `<td><div class="btn-group" data-type="att" data-day="${d}"><span class="opt ${rec.att=='1'?'act-att-1':''}" data-val="1">1</span><span class="opt ${rec.att=='-1'?'act-att--1':''}" data-val="-1">-1</span><span class="opt ${rec.att=='ç¼º'?'act-att-ç¼º':''}" data-val="ç¼º">ç¼º</span></div></td>
                      <td><div class="btn-group" data-type="hw" data-day="${d}">${['A','B','C','D','æœª'].map(v => `<span class="opt ${rec.hw==v?CLS_MAP.hw[v]:''}" data-val="${v}">${v==='æœª'?'Ã—':v}</span>`).join('')}</div></td>
                      <td><div class="btn-group" data-type="dt" data-day="${d}">${['æ»¡','è¿‡','é‡','æœª'].map(v => `<span class="opt ${rec.dt==v?CLS_MAP.dt[v]:''}" data-val="${v}">${v}</span>`).join('')}</div></td>
                      <td><div class="class-box" data-day="${d}"><button onclick="updCls(this,-1)">-</button><span class="score-val">${rec.cls}</span><button onclick="updCls(this,1)">+</button></div></td><td class="day-sum" id="sum-${sIdx}-${d}">0</td>`;
        }
        cells += `<td class="week-sum" id="total-${sIdx}" onclick="showWeeklyComparison()">0</td>`;
        tr.innerHTML = cells; body.appendChild(tr); calcScore(tr, sIdx);
    });
    if(monday) updateWeekDates(monday);
}

// --- åˆ†å€¼è®¡ç®—ä¸å§“åå˜è‰² ---
function calcScore(tr, sIdx) {
    let weekSum = 0;
    for(let d=0; d<5; d++) {
        let dSum = 0;
        ['att','hw','dt'].forEach(t => {
            const act = tr.querySelector(`[data-type="${t}"][data-day="${d}"] .opt[class*="act-"]`);
            if(act) dSum += (t === 'att' ? SCORE_MAP.att[act.dataset.val] : SCORE_MAP[t][act.dataset.val]);
        });
        dSum += parseInt(tr.querySelector(`.class-box[data-day="${d}"] .score-val`).innerText);
        const dsEl = document.getElementById(`sum-${sIdx}-${d}`); if(dsEl) dsEl.innerText = dSum;
        weekSum += dSum;
    }
    const tsEl = document.getElementById(`total-${sIdx}`); if(tsEl) tsEl.innerText = weekSum;
    const nameEl = tr.querySelector('.sticky-name');
    if(nameEl) {
        if (weekSum >= 40) nameEl.style.color = 'var(--rank-top)';
        else if (weekSum >= 30) nameEl.style.color = 'var(--rank-high)';
        else if (weekSum >= 20) nameEl.style.color = 'var(--rank-mid)';
        else nameEl.style.color = 'var(--rank-low)';
    }
}

// --- æ ·å¼çº§å¯¼å‡ºé€»è¾‘ ---
function exportWeek() {
    const monday = document.getElementById('mondayDate').value;
    const s_header = { fill: { fgColor: { rgb: "444444" } }, font: { color: { rgb: "FFFFFF" }, bold: true }, alignment: { horizontal: "center" } };
    const s_neg = { fill: { fgColor: { rgb: "FFC7CE" } }, font: { color: { rgb: "9C0006" } }, alignment: { horizontal: "center" } };
    const s_pos = { fill: { fgColor: { rgb: "C6EFCE" } }, font: { color: { rgb: "006100" } }, alignment: { horizontal: "center" } };
    const h1 = ["ç­çº§", "å§“å", "å‘¨ä¸€", "", "", "", "", "å‘¨äºŒ", "", "", "", "", "å‘¨ä¸‰", "", "", "", "", "å‘¨å››", "", "", "", "", "å‘¨äº”", "", "", "", "", "æ€»è®¡"];
    const h2 = ["", "", "å‡ºå‹¤", "ä½œä¸š", "å¬å†™", "è¯¾å ‚", "å½“æ—¥âˆ‘", "å‡ºå‹¤", "ä½œä¸š", "å¬å†™", "è¯¾å ‚", "å½“æ—¥âˆ‘", "å‡ºå‹¤", "ä½œä¸š", "å¬å†™", "è¯¾å ‚", "å½“æ—¥âˆ‘", "å‡ºå‹¤", "ä½œä¸š", "å¬å†™", "è¯¾å ‚", "å½“æ—¥âˆ‘", "å‡ºå‹¤", "ä½œä¸š", "å¬å†™", "è¯¾å ‚", "å½“æ—¥âˆ‘", ""];
    const rows = [];
    document.querySelectorAll('#tBody tr').forEach(tr => {
        const r = [ { v: tr.dataset.class }, { v: tr.dataset.name } ];
        for(let d=0; d<5; d++) {
            const att = tr.querySelector(`[data-type="att"][data-day="${d}"] .opt[class*="act-"]`)?.dataset.val || "";
            const hw = tr.querySelector(`[data-type="hw"][data-day="${d}"] .opt[class*="act-"]`)?.dataset.val || "";
            const dt = tr.querySelector(`[data-type="dt"][data-day="${d}"] .opt[class*="act-"]`)?.dataset.val || "";
            const cls = tr.querySelector(`.class-box[data-day="${d}"] .score-val`).innerText;
            const sum = tr.querySelector(`#sum-${tr.dataset.sidx}-${d}`).innerText;
            r.push(
                { v: att, s: att=='-1' ? s_neg : (att=='1' ? s_pos : {}) },
                { v: hw, s: (hw=='D'||hw=='æœª') ? s_neg : (['A','B'].includes(hw) ? s_pos : {}) },
                { v: dt, s: dt=='æœª' ? s_neg : (['æ»¡','è¿‡'].includes(dt) ? s_pos : {}) },
                { v: parseInt(cls) }, { v: parseInt(sum) }
            );
        }
        r.push({ v: parseInt(tr.querySelector('.week-sum').innerText), s: { font: { bold: true, color:{rgb:"FF0000"} } } });
        rows.push(r);
    });
    const ws = XLSX.utils.aoa_to_sheet([[{ v: `å‘¨æŠ¥(${monday})`, s:{font:{bold:true}} }], h1.map(h=>({v:h,s:s_header})), h2.map(h=>({v:h,s:s_header})), ...rows]);
    ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 27 } }, ...[0, 1, 2, 3, 4].map(i => ({ s: { r: 1, c: 2 + i * 5 }, e: { r: 1, c: 6 + i * 5 } })) ];
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "å‘¨æ•°æ®");
    XLSX.writeFile(wb, `å½©è‰²å‘¨æŠ¥_${monday}.xlsx`);
}

// --- æœˆåº¦æˆé•¿åˆ†æé€»è¾‘ (å›å½’) ---
function openMonth() { document.getElementById('ovl').style.display='block'; document.getElementById('monthModal').style.display='flex'; }

async function calcMonth(files) {
    monthData = {}; let weeks = [];
    const sortedFiles = Array.from(files).sort((a,b) => a.name.localeCompare(b.name));
    
    for(let i=0; i<sortedFiles.length; i++){
        const wKey = `W${i+1}`; weeks.push(wKey);
        const workbook = XLSX.read(await sortedFiles[i].arrayBuffer(), {type:'array'});
        const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header:1});
        
        // æˆ‘ä»¬ç°åœ¨çš„å¯¼å‡ºæ ¼å¼æ•°æ®ä»ç¬¬4è¡Œå¼€å§‹ (slice(3))
        data.slice(3).forEach(row => {
            if(!row[1]) return;
            const key = `${row[0]}-${row[1]}`;
            if(!monthData[key]) monthData[key] = { c:row[0], n:row[1], ws:[] };
            
            let att=0, hw=0, dt=0, cls=0;
            // æ¯éš”5åˆ—æå–ä¸€æ¬¡æ•°æ® [å‡º, ä½œ, å¬, è¯¾, âˆ‘]
            for(let d=0; d<5; d++) {
                const base = 2 + d * 5;
                // å‡ºå‹¤å¤„ç†ï¼š1, -1, ç¼º
                const aVal = row[base]; att += (aVal == '1' ? 1 : (aVal == '-1' ? -1 : 0));
                // ä½œä¸š/å¬å†™ï¼šç›´æ¥å–å…¶å¯¹åº”çš„ SCORE_MAP é€»è¾‘ï¼ˆå¯¼å‡ºæ—¶å·²æ˜¯é€‰é¡¹æ–‡å­—ï¼‰
                hw += (SCORE_MAP.hw[row[base+1]] || 0);
                dt += (SCORE_MAP.dt[row[base+2]] || 0);
                cls += (parseInt(row[base+3]) || 0);
            }
            monthData[key].ws.push({ att, hw, dt, cls, t: att+hw+dt+cls });
        });
    }
    renderMonthChart(Object.keys(monthData)[0], weeks);
}

function renderMonthChart(key, weeks) {
    const s = monthData[key], ctx = document.getElementById('monthChart').getContext('2d');
    if(monthChart) monthChart.destroy();
    monthChart = new Chart(ctx, {
        data: {
            labels: weeks,
            datasets: [
                { type:'line', label:'æ€»ç§¯åˆ†è¶‹åŠ¿', data: s.ws.map(x=>x.t), borderColor:'#ff4d4f', fill:false, tension:0.2, z:10 },
                { type:'bar', label:'å‡ºå‹¤', data: s.ws.map(x=>x.att), backgroundColor:'#52c41a' },
                { type:'bar', label:'ä½œä¸š', data: s.ws.map(x=>x.hw), backgroundColor:'#1890ff' },
                { type:'bar', label:'å¬å†™', data: s.ws.map(x=>x.dt), backgroundColor:'#722ed1' },
                { type:'bar', label:'è¯¾å ‚', data: s.ws.map(x=>x.cls), backgroundColor:'#faad14' }
            ]
        },
        options: { 
            responsive:true, maintainAspectRatio:false, 
            scales: { x:{stacked:true}, y:{stacked:true} },
            plugins: { title: { display:true, text: `${s.n} çš„æœˆåº¦æˆé•¿è½¨è¿¹` } }
        }
    });
    
    // ç”Ÿæˆåˆ—è¡¨
    let h = `<table border="1" style="width:100%; border-collapse:collapse"><thead><tr><th>ç­çº§</th><th>å§“å</th><th>æœˆåº¦ç´¯è®¡</th><th>æ“ä½œ</th></tr></thead><tbody>`;
    Object.keys(monthData).forEach(x => {
        const total = monthData[x].ws.reduce((a,b)=>a+b.t,0);
        h += `<tr><td>${monthData[x].c}</td><td>${monthData[x].n}</td><td>${total}</td><td><button class="primary" onclick="renderMonthChart('${x}', ${JSON.stringify(weeks)})">æŸ¥çœ‹å›¾è¡¨</button></td></tr>`;
    });
    document.getElementById('monthList').innerHTML = h + `</tbody></table>`;
}

function exportMonth() {
    const data = Object.values(monthData).map(s => {
        const r = { 'ç­çº§':s.c, 'å§“å':s.n };
        s.ws.forEach((w,i) => r[`W${i+1}`] = w.t);
        r['å…¨æœˆæ€»è®¡'] = s.ws.reduce((a,b)=>a+b.t,0);
        return r;
    });
    XLSX.writeFile(XLSX.utils.book_append_sheet(XLSX.utils.book_new(), XLSX.utils.json_to_sheet(data), "æœˆåº¦æ±‡æ€»"), "æœˆåº¦ç§¯åˆ†ç»Ÿè®¡æ±‡æ€».xlsx");
}

// --- å…¶ä»–åŠŸèƒ½ (å¯¹æ¯”æ’åºã€ä¿å­˜ç­‰) ---
function showWeeklyComparison() {
    let ds = []; document.querySelectorAll('#tBody tr').forEach(tr => { ds.push({ name: tr.dataset.name, total: parseInt(tr.querySelector('.week-sum').innerText) }); });
    if(isCompareSorted) ds.sort((a, b) => b.total - a.total);
    const ns = ds.map(d => d.name), ts = ds.map(d => d.total);
    document.getElementById('ovl').style.display = 'block'; document.getElementById('compareModal').style.display = 'flex';
    const dw = Math.max(document.getElementById('compareScrollWrapper').clientWidth - 20, ns.length * 45);
    document.getElementById('compareInner').style.width = dw + 'px';
    const ctx = document.getElementById('compareChart').getContext('2d');
    if(compareChart) compareChart.destroy();
    compareChart = new Chart(ctx, {
        type: 'bar', data: { labels: ns, datasets: [{ label: 'å¾—åˆ†', data: ts, backgroundColor: ts.map(v => { if (v >= 40) return '#fa8c16'; if (v >= 30) return '#722ed1'; if (v >= 20) return '#1890ff'; return '#8c8c8c'; }), borderRadius: 4 }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
    });
}

function toggleCompareSort() { isCompareSorted = !isCompareSorted; document.getElementById('sortBtn').innerText = isCompareSorted ? "æ’åºï¼šæŒ‰åˆ†æ•°" : "æ’åºï¼šæŒ‰åå•"; showWeeklyComparison(); }

function updCls(btn, delta) {
    const span = btn.parentElement.querySelector('.score-val'), tr = btn.closest('tr');
    span.innerText = parseInt(span.innerText) + delta;
    calcScore(tr, tr.dataset.sidx); autoSave();
}

function updateWeekDates(v) {
    if(!v) return; const m = new Date(v);
    for(let i=1; i<5; i++) {
        const t = new Date(m); t.setDate(m.getDate()+i);
        const l = document.getElementById(`date-label-${i}`); if(l) l.innerText = `${(t.getMonth()+1).toString().padStart(2,'0')} / ${t.getDate().toString().padStart(2,'0')}`;
    }
    autoSave();
}

function autoSave() {
    const recs = {};
    document.querySelectorAll('#tBody tr').forEach(tr => {
        const n = tr.dataset.name; recs[n] = {};
        for(let d=0; d<5; d++) {
            recs[n][d] = {
                att: tr.querySelector(`[data-type="att"][data-day="${d}"] .opt[class*="act-"]`)?.dataset.val || '',
                hw: tr.querySelector(`[data-type="hw"][data-day="${d}"] .opt[class*="act-"]`)?.dataset.val || '',
                dt: tr.querySelector(`[data-type="dt"][data-day="${d}"] .opt[class*="act-"]`)?.dataset.val || '',
                cls: parseInt(tr.querySelector(`.class-box[data-day="${d}"] .score-val`).innerText)
            };
        }
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ students:currentStudentList, records:recs, monday:document.getElementById('mondayDate')?.value||'' }));
}

document.body.addEventListener('click', e => {
    if(!e.target.classList.contains('opt')) return;
    const opt = e.target, p = opt.parentElement, type = p.dataset.type, val = opt.dataset.val, tr = opt.closest('tr');
    let tCls = type==='att' ? `act-att-${val}` : CLS_MAP[type][val];
    const isA = opt.classList.contains(tCls);
    Array.from(p.children).forEach(o => { const c = Array.from(o.classList).find(x => x.startsWith('act-')); if(c) o.classList.remove(c); });
    if(!isA) opt.classList.add(tCls);
    calcScore(tr, tr.dataset.sidx); autoSave();
});

function showRadar(sIdx) {
    const tr = document.querySelector(`tr[data-sidx="${sIdx}"]`), name = tr.dataset.name;
    let s = { att:0, hw:0, dt:0, cls:0 };
    for(let d=0; d<5; d++) {
        const a = tr.querySelector(`[data-type="att"][data-day="${d}"] .opt[class*="act-"]`); if(a) s.att += SCORE_MAP.att[a.dataset.val];
        const h = tr.querySelector(`[data-type="hw"][data-day="${d}"] .opt[class*="act-"]`); if(h) s.hw += SCORE_MAP.hw[h.dataset.val];
        const dt = tr.querySelector(`[data-type="dt"][data-day="${d}"] .opt[class*="act-"]`); if(dt) s.dt += SCORE_MAP.dt[dt.dataset.val];
        s.cls += parseInt(tr.querySelector(`.class-box[data-day="${d}"] .score-val`).innerText);
    }
    const norm = (v, t) => {
        if (t === 'att') return (v/5)*100; if (t === 'hw' || t === 'dt') return (v/15)*100;
        if (t === 'cls') { if(v<=0) return (v/10)*100; if(v<=5) return (v/5)*66.6; return 66.6+((v-5)/5)*33.4; }
        return v;
    };
    document.getElementById('ovl').style.display = 'block'; document.getElementById('radarModal').style.display = 'block';
    document.getElementById('rTitle').innerText = `${name} å‘¨èƒ½åŠ›åˆ†å¸ƒ`;
    if(radarChart) radarChart.destroy();
    radarChart = new Chart(document.getElementById('radarChart'), {
        type: 'radar',
        data: {
            labels: [`å‡ºå‹¤(${s.att})`,`ä½œä¸š(${s.hw})`,`å¬å†™(${s.dt})`,`è¯¾å ‚(${s.cls})`],
            datasets: [{ label:'èƒ½åŠ›ç™¾åˆ†æ¯”', data:[norm(s.att,'att'),norm(s.hw,'hw'),norm(s.dt,'dt'),norm(s.cls,'cls')], backgroundColor:'rgba(24,144,255,0.2)', borderColor:'#1890ff' }]
        },
        options: { scales: { r: { min:-20, max:100, ticks:{display:false} } } }
    });
}

function closeAll() { document.querySelectorAll('.modal, .overlay').forEach(el => el.style.display='none'); }
function clearAllRecords() { if(confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰æœ¬åœ°è®°å½•å¹¶é‡æ–°åŒæ­¥äº‘ç«¯æ¯ç‰ˆå—ï¼Ÿ")) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }
function syncManual() {
    const act = prompt("EXPORT: å¤åˆ¶æ•°æ®ä»£ç \nIMPORT: ç²˜è´´ä»£ç åŒæ­¥");
    if(act==='EXPORT') { alert(localStorage.getItem(STORAGE_KEY)); }
    else if(act==='IMPORT') { const c = prompt("è¯·åœ¨æ­¤ç²˜è´´åŒæ­¥ä»£ç "); if(c){localStorage.setItem(STORAGE_KEY, c); location.reload();} }
}
</script>
</body>
</html>