
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½é˜…å·ç»ˆç«¯ - ç¨³å®šç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://docs.opencv.org/4.5.2/opencv.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary-color: #0d6efd; --bg-light: #f1f3f5; }
        body { background-color: var(--bg-light); font-family: system-ui, -apple-system, sans-serif; }
        .app-container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; }
        
        .camera-card { border: none; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.08); background: #fff; overflow: hidden; }
        .video-container { 
            position: relative; 
            background: #000; 
            width: 100%; 
            aspect-ratio: 210 / 297; 
            margin: 0 auto;
        }
        #video { width: 100%; height: 100%; object-fit: cover; }
        
        #answerStatus { font-size: 0.8rem; border-radius: 20px; padding: 4px 12px; display: inline-block; cursor: pointer; transition: 0.3s; }
        .status-none { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .status-ready { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }

        .table-card { border: none; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); background: #fff; padding: 1.5rem; }
        .btn-delete { color: #dc3545; cursor: pointer; border: none; background: none; font-size: 1.2rem; }
        
        #apiOverlay, #answerModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                                    background: rgba(0,0,0,0.8); z-index: 10000; backdrop-filter: blur(4px);
                                    justify-content: center; align-items: center; }
        .modal-box { background: #fff; padding: 2rem; border-radius: 1.2rem; width: 90%; max-width: 500px; }
        
        #loadingLayer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                         background: rgba(255,255,255,0.9); z-index: 9000; flex-direction: column; 
                         justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="apiOverlay">
    <div class="modal-box text-center shadow-lg">
        <h4 class="fw-bold mb-3">ğŸ”‘ API åˆå§‹åŒ–</h4>
        <input type="password" id="apiKeyInput" class="form-control form-control-lg mb-4" placeholder="sk-xxxx">
        <button class="btn btn-primary btn-lg w-100 shadow-sm" onclick="saveKey()">ä¿å­˜å¹¶å¯åŠ¨</button>
    </div>
</div>

<div id="answerModal">
    <div class="modal-box shadow-lg">
        <h5 class="fw-bold mb-3">ğŸ¯ æ ‡å‡†ç­”æ¡ˆé¢„è§ˆ</h5>
        <div id="answerContent" class="p-3 bg-light rounded mb-4 small" style="white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></div>
        <div class="d-flex gap-2">
            <button class="btn btn-secondary w-100" onclick="closeAnswerModal()">å…³é—­</button>
            <button class="btn btn-outline-danger w-100" onclick="clearAnswers()">é‡å½•ç­”æ¡ˆ</button>
        </div>
    </div>
</div>

<div id="loadingLayer">
    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
    <h5 id="loadingText" class="fw-bold text-primary">AI æ­£åœ¨æ‰«æ...</h5>
</div>

<div class="app-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1">ğŸ“– AI æ™ºèƒ½é˜…å·ç»ˆç«¯</h2>
            <div id="answerStatus" class="status-none" onclick="previewAnswers()">âš ï¸ å°šæœªå½•å…¥ç­”æ¡ˆ (ç‚¹å‡»é¢„è§ˆ)</div>
        </div>
        <div class="btn-group">
            <button class="btn btn-outline-danger btn-sm" onclick="fullReset()">ğŸ§¹ å…¨éƒ¨æ¸…ç©º</button>
            <button class="btn btn-success fw-bold ms-2" onclick="exportExcel()">ğŸ“Š å¯¼å‡ºè¡¨æ ¼</button>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="camera-card">
                <div class="video-container">
                    <video id="video" autoplay playsinline></video>
                </div>
                <div class="p-3 bg-white">
                    <div class="row g-2">
                        <div class="col-6">
                            <button class="btn btn-warning btn-lg w-100 py-3 fw-bold shadow-sm" id="btnKey" onclick="scanMode('KEY')">ğŸ¯ å½•å…¥ç­”æ¡ˆå¡</button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-primary btn-lg w-100 py-3 fw-bold shadow-sm" id="btnStudent" onclick="scanMode('STUDENT')">ğŸ“ æ‰¹æ”¹å­¦ç”Ÿå¡</button>
                        </div>
                    </div>
                </div>
            </div>
            <canvas id="hiddenCanvas" style="display:none;"></canvas>
        </div>

        <div class="col-lg-7">
            <div class="table-card">
                <h5 class="fw-bold mb-4">æˆç»©è¡¨ (è‡ªåŠ¨å­˜æ¡£)</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="mainTable">
                        <thead class="table-light">
                            <tr>
                                <th>ç­çº§</th><th>å§“å</th><th>å¬åŠ›</th><th>é˜…è¯»</th><th>å®Œå½¢</th><th>å¡«ç©º</th><th class="table-warning">ä½œæ–‡</th><th>æ€»åˆ†</th><th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('hiddenCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    
    let appState = {
        apiKey: localStorage.getItem('ALI_QWEN_KEY'),
        savedAnswers: JSON.parse(localStorage.getItem('SAVED_ANSWERS')) || null,
        records: JSON.parse(localStorage.getItem('STUDENT_RECORDS')) || []
    };

    window.onload = () => {
        if (!appState.apiKey) document.getElementById('apiOverlay').style.display = 'flex';
        else { initApp(); renderSavedData(); }
    };

    function saveKey() {
        const val = document.getElementById('apiKeyInput').value.trim();
        if (val.startsWith('sk-')) {
            localStorage.setItem('ALI_QWEN_KEY', val);
            location.reload();
        }
    }

    async function initApp() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } 
            });
            video.srcObject = stream;
            // ç¡®ä¿è§†é¢‘å§‹ç»ˆæ’­æ”¾ï¼Œé˜²æ­¢å†»ç»“
            video.onloadedmetadata = () => video.play(); 
            updateAnswerStatus();
        } catch (e) { alert("ç›¸æœºæƒé™è¢«æ‹’ç»"); }
    }

    function renderSavedData() {
        const tbody = document.querySelector('#mainTable tbody');
        tbody.innerHTML = "";
        appState.records.forEach((record, index) => appendRowToTable(record, index));
    }

    function updateAnswerStatus() {
        const status = document.getElementById('answerStatus');
        if (appState.savedAnswers) {
            status.innerText = "âœ… ç­”æ¡ˆå·²å°±ç»ª (ç‚¹å‡»é¢„è§ˆ)";
            status.className = "status-ready";
        } else {
            status.innerText = "âš ï¸ å°šæœªå½•å…¥ç­”æ¡ˆ (è¯·å…ˆæ‰«æ)";
            status.className = "status-none";
        }
    }

    async function scanMode(mode) {
        if (mode === 'STUDENT' && !appState.savedAnswers) return alert("è¯·å…ˆå½•å…¥ç­”æ¡ˆå¡ï¼");

        const btnKey = document.getElementById('btnKey');
        const btnStudent = document.getElementById('btnStudent');
        
        try {
            // é”å®šæŒ‰é’®é˜²æ­¢é‡å…¥
            btnKey.disabled = true;
            btnStudent.disabled = true;

            const MAX_SIDE = 1024;
            let scale = Math.min(MAX_SIDE / video.videoWidth, MAX_SIDE / video.videoHeight);
            canvas.width = video.videoWidth * scale;
            canvas.height = video.videoHeight * scale;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            if (typeof cv !== 'undefined' && cv.Mat) {
                try {
                    let mat = cv.imread(canvas);
                    cv.cvtColor(mat, mat, cv.ColorConversionCodes.COLOR_RGBA2GRAY);
                    cv.convertScaleAbs(mat, mat, 1.4, 20); // ç•¥å¾®å¢å¼ºå¯¹æ¯”åº¦
                    cv.imshow(canvas, mat);
                    mat.delete();
                } catch (e) {}
            }

            const base64Img = canvas.toDataURL('image/jpeg', 0.85);
            document.getElementById('loadingLayer').style.display = 'flex';
            document.getElementById('loadingText').innerText = mode === 'KEY' ? "å½•å…¥æ ‡å‡†ç­”æ¡ˆ..." : "æ­£åœ¨æ¯”å¯¹æ‰¹æ”¹...";

            // --- é€»è¾‘ä¼˜åŒ–ï¼šæ˜ç¡®è¦æ±‚å¡«æ¶‚æœ€é»‘çš„éƒ¨åˆ† ---
            const prompt = mode === 'KEY' 
                ? "ä½ æ˜¯ä¸€ä¸ªç²¾å‡†çš„ç­”é¢˜å¡è¯†åˆ«å™¨ã€‚è¿™æ˜¯æ ‡å‡†ç­”æ¡ˆå¡ã€‚ç­”é¢˜æ–¹å¼ä¸ºå¡«æ¶‚ï¼ˆç”¨é»‘è‰²ç¬”æ¶‚æ»¡é€‰é¡¹æ¡†ï¼‰ã€‚è¯·è¯†åˆ«æ¯é“å¤§é¢˜æ¶‚é»‘ç¨‹åº¦æœ€é«˜ã€é¢œè‰²æœ€æ·±çš„é€‰é¡¹ä½œä¸ºæ­£ç¡®ç­”æ¡ˆã€‚è¿”å› JSONï¼š{\"listening\":\"...\",\"reading\":\"...\",\"cloze\":\"...\",\"filling\":\"...\"}"
                : `å­¦ç”Ÿé˜…å·ã€‚æ ‡å‡†ç­”æ¡ˆï¼š${JSON.stringify(appState.savedAnswers)}ã€‚è¯†åˆ«å¡«æ¶‚æœ€é»‘çš„é€‰é¡¹ã€‚æ¯”å¯¹åè¯„åˆ†ã€‚è¿”å› JSONï¼š{\"class\":\"\",\"name\":\"\",\"listening\":0,\"reading\":0,\"cloze\":0,\"filling\":0}`;

            const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${appState.apiKey}` },
                body: JSON.stringify({
                    model: "qwen3-vl-flash",
                    messages: [{ role: "user", content: [{ type: "text", text: prompt }, { type: "image_url", image_url: { url: base64Img } }]}],
                    response_format: { type: "json_object" }
                })
            });

            if (!response.ok) throw new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥");
            
            const resData = await response.json();
            const result = JSON.parse(resData.choices[0].message.content);

            if (mode === 'KEY') {
                appState.savedAnswers = result;
                localStorage.setItem('SAVED_ANSWERS', JSON.stringify(result));
                updateAnswerStatus();
                previewAnswers();
            } else {
                appState.records.push(result);
                localStorage.setItem('STUDENT_RECORDS', JSON.stringify(appState.records));
                renderSavedData();
            }
        } catch (err) {
            alert("è¯†åˆ«å¼‚å¸¸: " + err.message);
        } finally {
            // --- å…³é”®ä¿®å¤ï¼šç¡®ä¿ UI è§£é”å’Œç›¸æœºæ¢å¤ ---
            document.getElementById('loadingLayer').style.display = 'none';
            btnKey.disabled = false;
            btnStudent.disabled = false;
            video.play(); // å¼ºåˆ¶è§†é¢‘é‡æ–°å¼€å§‹æ’­æ”¾ï¼Œé˜²æ­¢åœ¨æŸäº›æµè§ˆå™¨ä¸‹å›  canvas æŠ“å–è€Œæš‚åœ
        }
    }

    // --- è¡¨æ ¼äº¤äº’ä¸å¯¼å‡º ---
    function appendRowToTable(data, index) {
        const tbody = document.querySelector('#mainTable tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td contenteditable="true" oninput="updateRecord(${index}, 'class', this)">${data.class || '-'}</td>
            <td contenteditable="true" oninput="updateRecord(${index}, 'name', this)">${data.name || '-'}</td>
            <td contenteditable="true" class="score-input" oninput="updateRecord(${index}, 'listening', this)">${data.listening || 0}</td>
            <td contenteditable="true" class="score-input" oninput="updateRecord(${index}, 'reading', this)">${data.reading || 0}</td>
            <td contenteditable="true" class="score-input" oninput="updateRecord(${index}, 'cloze', this)">${data.cloze || 0}</td>
            <td contenteditable="true" class="score-input" oninput="updateRecord(${index}, 'filling', this)">${data.filling || 0}</td>
            <td contenteditable="true" class="score-input table-warning" oninput="updateRecord(${index}, 'essay', this)">${data.essay || 0}</td>
            <td class="fw-bold text-primary total-score">0</td>
            <td class="text-center"><button class="btn-delete" onclick="deleteRow(${index})">ğŸ—‘ï¸</button></td>
        `;
        tbody.appendChild(tr);
        calculateTotal(tr);
    }

    function updateRecord(index, field, el) {
        let val = (field === 'class' || field === 'name') ? el.innerText : parseFloat(el.innerText) || 0;
        appState.records[index][field] = val;
        localStorage.setItem('STUDENT_RECORDS', JSON.stringify(appState.records));
        calculateTotal(el.closest('tr'));
    }

    function calculateTotal(row) {
        let total = 0;
        row.querySelectorAll('.score-input').forEach(td => total += parseFloat(td.innerText) || 0);
        row.querySelector('.total-score').innerText = total;
    }

    function deleteRow(index) {
        if (confirm("åˆ é™¤æ­¤è¡Œæ•°æ®ï¼Ÿ")) {
            appState.records.splice(index, 1);
            localStorage.setItem('STUDENT_RECORDS', JSON.stringify(appState.records));
            renderSavedData();
        }
    }

    function previewAnswers() {
        if (!appState.savedAnswers) return alert("æš‚æ— æ•°æ®");
        document.getElementById('answerContent').innerText = JSON.stringify(appState.savedAnswers, null, 4);
        document.getElementById('answerModal').style.display = 'flex';
    }

    function closeAnswerModal() { document.getElementById('answerModal').style.display = 'none'; }

    function clearAnswers() {
        if(confirm("ç¡®å®šæ¸…é™¤æ ‡å‡†ç­”æ¡ˆï¼Ÿ")) {
            appState.savedAnswers = null;
            localStorage.removeItem('SAVED_ANSWERS');
            updateAnswerStatus();
            closeAnswerModal();
        }
    }

    function fullReset() {
        if (confirm("ğŸš¨ è¿™å°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰æ•°æ®ï¼ˆåŒ…å« Keyï¼‰ï¼Œç¡®å®šå—ï¼Ÿ")) {
            localStorage.clear();
            location.reload();
        }
    }

    function exportExcel() {
        const wb = XLSX.utils.table_to_book(document.getElementById('mainTable'), {sheet: "Sheet1"});
        XLSX.writeFile(wb, `é˜…å·æ±‡æ€»_${new Date().getTime()}.xlsx`);
    }
</script>

</body>
</html>
