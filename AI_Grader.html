
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½é˜…å·ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://docs.opencv.org/4.5.2/opencv.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { background: #f4f7f6; padding: 20px; }
        .camera-box { border: 2px dashed #0d6efd; border-radius: 10px; overflow: hidden; position: relative; }
        video { width: 100%; transform: scaleX(1); }
        #canvasOutput { display: none; }
        .result-table { background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1000; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div class="loading-overlay" id="loading">
    <div class="spinner-border text-primary" role="status"></div>
    <span class="ms-3">AI æ­£åœ¨åŠªåŠ›æ‰¹æ”¹ä¸­ï¼Œè¯·ç¨å€™...</span>
</div>

<div class="container">
    <h2 class="text-center mb-4">ğŸ“– AI æ™ºèƒ½é˜…å·ç»ˆç«¯</h2>
    
    <div class="row">
        <div class="col-md-5">
            <div class="card p-3">
                <h5>1. è®¾ç½®ä¸å½•å…¥</h5>
                <input type="password" id="apiKey" class="form-control mb-2" placeholder="è¯·è¾“å…¥ DeepSeek API Key">
                <div class="camera-box mb-3">
                    <video id="video" autoplay playsinline></video>
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="captureAndProcess()">ğŸ“¸ æ‹ç…§å¹¶æ‰¹æ”¹</button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="startCamera()">é‡è¿æ‘„åƒå¤´</button>
                </div>
                <canvas id="canvasHidden" style="display:none;"></canvas>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>2. æ‰¹æ”¹ç»“æœæ±‡æ€»</h5>
                    <button class="btn btn-success" onclick="exportToExcel()">ğŸ“Š å¯¼å‡º Excel</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover result-table" id="scoreTable">
                        <thead class="table-light">
                            <tr>
                                <th>ç­çº§</th>
                                <th>å§“å</th>
                                <th>å¬åŠ›</th>
                                <th>é˜…è¯»</th>
                                <th>å®Œå½¢</th>
                                <th>å¡«ç©º</th>
                                <th>ä½œæ–‡(æ‰‹åŠ¨)</th>
                                <th>æ€»åˆ†</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let video = document.getElementById('video');
    let canvasHidden = document.getElementById('canvasHidden');

    // å¯åŠ¨æ‘„åƒå¤´
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream;
        } catch (err) {
            alert("æ— æ³•è®¿é—®æ‘„åƒå¤´: " + err);
        }
    }
    startCamera();

    // å›¾åƒé¢„å¤„ç†å‡½æ•°
    function preprocessImage(src) {
        let dst = new cv.Mat();
        cv.cvtColor(src, src, cv.ColorConversionCodes.COLOR_RGBA2GRAY); // è½¬ç°åº¦
        cv.GaussianBlur(src, src, new cv.Size(3, 3), 0); // å»å™ª
        cv.adaptiveThreshold(src, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 11, 2); // è‡ªé€‚åº”äºŒå€¼åŒ–
        return dst;
    }

    // æ ¸å¿ƒæµç¨‹ï¼šæ‹ç…§ -> é¢„å¤„ç† -> AI æ‰¹æ”¹
    async function captureAndProcess() {
        const key = document.getElementById('apiKey').value;
        if (!key) return alert("è¯·å…ˆè¾“å…¥ API Key");

        // 1. æ‹ç…§
        canvasHidden.width = video.videoWidth;
        canvasHidden.height = video.videoHeight;
        let ctx = canvasHidden.getContext('2d');
        ctx.drawImage(video, 0, 0);
        
        // 2. OpenCV å¢å¼º (è¿™é‡Œæ¼”ç¤ºé€»è¾‘ï¼Œå®é™…è°ƒç”¨ API æ—¶å‘é€åŸå›¾æˆ–å¢å¼ºå›¾å‡å¯ï¼Œå»ºè®®å‘é€å¢å¼ºåçš„ Base64)
        // æ³¨æ„ï¼šOpenCV.js åŠ è½½éœ€è¦æ—¶é—´ï¼Œç”Ÿäº§ç¯å¢ƒéœ€åŠ åˆ¤å®š
        let base64Image = canvasHidden.toDataURL('image/jpeg', 0.8);

        // 3. è°ƒç”¨ AI
        document.getElementById('loading').style.display = 'flex';
        try {
            const response = await fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${key}`
                },
                body: JSON.stringify({
                    model: "deepseek-chat", // å»ºè®®ä½¿ç”¨å…·å¤‡ vision èƒ½åŠ›çš„æ¨¡å‹ï¼Œå¦‚ deepseek-v3
                    messages: [
                        {
                            role: "user",
                            content: [
                                { type: "text", text: "ä½ æ˜¯ä¸€ä¸ªé˜…å·åŠ©æ‰‹ã€‚è¯·ä»å›¾ç‰‡ä¸­æå–ï¼šç­çº§ã€å§“åã€å¬åŠ›å¾—åˆ†ã€é˜…è¯»å¾—åˆ†ã€å®Œå½¢å¡«ç©ºå¾—åˆ†ã€é€‚å½“å½¢å¼å¡«ç©ºå¾—åˆ†ã€‚åŒæ—¶æŠ“å–æ¯é¢˜åˆ†å€¼è®¡ç®—é€»è¾‘ã€‚è¯·åªè¿”å› JSON æ ¼å¼ï¼Œå­—æ®µåä¸º: class, name, listening, reading, cloze, fillingã€‚" },
                                { type: "image_url", image_url: { url: base64Image } }
                            ]
                        }
                    ],
                    response_format: { type: 'json_object' }
                })
            });

            const result = await response.json();
            const data = JSON.parse(result.choices[0].message.content);
            addRow(data);
        } catch (err) {
            console.error(err);
            alert("æ‰¹æ”¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– API Key");
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // åŠ¨æ€æ·»åŠ è¡Œ
    function addRow(data) {
        const tbody = document.querySelector('#scoreTable tbody');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td contenteditable="true">${data.class || ''}</td>
            <td contenteditable="true">${data.name || ''}</td>
            <td contenteditable="true" class="score-input">${data.listening || 0}</td>
            <td contenteditable="true" class="score-input">${data.reading || 0}</td>
            <td contenteditable="true" class="score-input">${data.cloze || 0}</td>
            <td contenteditable="true" class="score-input">${data.filling || 0}</td>
            <td contenteditable="true" class="score-input essay-score">0</td>
            <td class="total-score fw-bold text-primary">0</td>
        `;
        tbody.appendChild(row);
        
        // ç»‘å®šè‡ªåŠ¨è®¡ç®—
        row.querySelectorAll('[contenteditable]').forEach(cell => {
            cell.oninput = () => calculateTotal(row);
        });
        calculateTotal(row);
    }

    function calculateTotal(row) {
        let total = 0;
        row.querySelectorAll('.score-input').forEach(cell => {
            total += parseFloat(cell.innerText) || 0;
        });
        row.querySelector('.total-score').innerText = total;
    }

    // å¯¼å‡º Excel
    function exportToExcel() {
        const table = document.getElementById('scoreTable');
        const wb = XLSX.utils.table_to_book(table, { sheet: "æˆç»©æ±‡æ€»" });
        XLSX.writeFile(wb, `é˜…å·æˆç»©å¯¼å‡º_${new Date().toLocaleDateString()}.xlsx`);
    }
</script>

</body>
</html>
