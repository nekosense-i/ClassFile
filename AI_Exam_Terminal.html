
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½é˜…å·ç³»ç»Ÿ - æ——èˆ°ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://docs.opencv.org/4.5.2/opencv.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary-color: #0d6efd; --bg-light: #f4f7f9; }
        body { background-color: var(--bg-light); font-family: system-ui, -apple-system, sans-serif; }
        .app-container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; }
        
        /* è§†é¢‘é¢„è§ˆåŒº */
        .camera-card { border: none; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); background: #fff; overflow: hidden; }
        .video-container { position: relative; background: #000; aspect-ratio: 4/3; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        
        /* ç»“æœå±•ç¤ºåŒº */
        .table-card { border: none; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); background: #fff; padding: 1.5rem; }
        .table th { font-weight: 600; font-size: 0.85rem; color: #6c757d; text-transform: uppercase; }
        .score-input { font-weight: 700; color: var(--primary-color); }
        .total-score { background-color: #e7f1ff !important; font-weight: 800; color: #0056b3; }
        
        /* å¼ºåˆ¶å¼¹çª— */
        #apiOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                        background: rgba(0,0,0,0.85); z-index: 10000; backdrop-filter: blur(5px);
                        justify-content: center; align-items: center; }
        .api-modal { background: #fff; padding: 2.5rem; border-radius: 1.5rem; width: 90%; max-width: 450px; text-align: center; }

        /* åŠ è½½åŠ¨ç”» */
        #loadingLayer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                         background: rgba(255,255,255,0.8); z-index: 9000; flex-direction: column; 
                         justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="apiOverlay">
    <div class="api-modal">
        <div class="mb-4">
            <h4 class="fw-bold">ğŸ”‘ åˆå§‹åŒ– API è®¾ç½®</h4>
            <p class="text-muted small">è¯·è¾“å…¥æ‚¨çš„é˜¿é‡Œäº‘ DashScope API Key ä»¥å¯åŠ¨ç³»ç»Ÿ</p>
        </div>
        <input type="password" id="apiKeyInput" class="form-control form-control-lg mb-3" placeholder="sk-xxxxxxxx">
        <button class="btn btn-primary btn-lg w-100 shadow-sm" onclick="saveKey()">ä¿å­˜å¹¶å¼€å§‹é˜…å·</button>
        <div class="mt-3 small text-start">
            <ul class="text-muted">
                <li>å¯†é’¥ä»…ä¿å­˜åœ¨æ‚¨çš„æµè§ˆå™¨ localStorage ä¸­</li>
                <li>éƒ¨ç½²åœ¨ GitHub/Cloudflare æ—¶æºç ä¿æŒå®‰å…¨</li>
            </ul>
        </div>
    </div>
</div>

<div id="loadingLayer">
    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
    <h5 class="fw-bold text-primary">Qwen3-VL-Flash æ­£åœ¨é˜…å·...</h5>
</div>

<div class="app-container">
    <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <h2 class="fw-bold mb-0">ğŸ“– æ™ºèƒ½é˜…å·ç»ˆç«¯</h2>
            <p class="text-muted mb-0">åŸºäº Qwen3-VL-Flash çš„æè‡´å“åº”æ¨¡å¼</p>
        </div>
        <div>
            <button class="btn btn-outline-secondary btn-sm me-2" onclick="resetKey()">æ›´æ¢å¯†é’¥</button>
            <button class="btn btn-success" onclick="exportExcel()">ğŸ“Š å¯¼å‡º Excel æˆç»©å•</button>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-xl-5 col-lg-6">
            <div class="camera-card">
                <div class="video-container">
                    <video id="video" autoplay playsinline></video>
                </div>
                <div class="p-4 bg-white">
                    <button class="btn btn-primary btn-lg w-100 py-3 mb-3 fw-bold shadow" onclick="scanSheet()">ğŸ“¸ æ‹ç…§è¯†åˆ« (çœæµæ¨¡å¼)</button>
                    <div class="d-flex justify-content-between text-muted small">
                        <span>åˆ†è¾¨ç‡: 1024px è‡ªåŠ¨ç¼©æ”¾</span>
                        <span>å›¾åƒå¢å¼º: å·²å¼€å¯</span>
                    </div>
                </div>
            </div>
            <canvas id="hiddenCanvas" style="display:none;"></canvas>
        </div>

        <div class="col-xl-7 col-lg-6">
            <div class="table-card h-100 d-flex flex-column">
                <h5 class="fw-bold mb-4">æˆç»©å®æ—¶æ±‡æ€»</h5>
                <div class="table-responsive flex-grow-1">
                    <table class="table table-hover align-middle" id="mainTable">
                        <thead>
                            <tr>
                                <th>ç­çº§</th>
                                <th>å§“å</th>
                                <th>å¬åŠ›</th>
                                <th>é˜…è¯»</th>
                                <th>å®Œå½¢</th>
                                <th>å¡«ç©º</th>
                                <th class="table-warning">ä½œæ–‡(æ‰‹å†™)</th>
                                <th>æ€»åˆ†</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                <div class="mt-3 text-muted x-small">
                    * å•å…ƒæ ¼å¯æ‰‹åŠ¨ç‚¹å‡»ä¿®æ”¹ã€‚ä½œæ–‡åˆ†ç”±è€å¸ˆæ‰‹åŠ¨å½•å…¥åè‡ªåŠ¨è®¡ç®—æ€»åˆ†ã€‚
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('hiddenCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    let DASH_KEY = localStorage.getItem('ALI_QWEN_KEY');

    // 1. åˆå§‹åŒ–é‰´æƒ
    window.onload = () => {
        if (!DASH_KEY) {
            document.getElementById('apiOverlay').style.display = 'flex';
        } else {
            initApp();
        }
    };

    function saveKey() {
        const val = document.getElementById('apiKeyInput').value.trim();
        if (val.startsWith('sk-')) {
            localStorage.setItem('ALI_QWEN_KEY', val);
            DASH_KEY = val;
            document.getElementById('apiOverlay').style.display = 'none';
            initApp();
        } else {
            alert("API Key æ ¼å¼ä¸æ­£ç¡®");
        }
    }

    function resetKey() {
        if(confirm("ç¡®å®šè¦é‡ç½® API Key å—ï¼Ÿ")) {
            localStorage.removeItem('ALI_QWEN_KEY');
            location.reload();
        }
    }

    async function initApp() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } 
            });
            video.srcObject = stream;
        } catch (e) {
            alert("æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿é¡µé¢åœ¨ HTTPS ç¯å¢ƒä¸‹è¿è¡Œ");
        }
    }

    // 2. æ ¸å¿ƒæ‰«æä¸å¤„ç†é€»è¾‘
    async function scanSheet() {
        if (!DASH_KEY) return;
        
        // --- é™é‡‡æ ·å¤„ç† (Token çœæµæ ¸å¿ƒ) ---
        const MAX_SIDE = 1024;
        let w = video.videoWidth;
        let h = video.videoHeight;
        let scale = 1;
        if (w > MAX_SIDE || h > MAX_SIDE) {
            scale = w > h ? MAX_SIDE / w : MAX_SIDE / h;
        }
        canvas.width = w * scale;
        canvas.height = h * scale;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // --- OpenCV å›¾åƒå¢å¼º (å¢å¼ºè¯†åˆ«æ¸…æ™°åº¦) ---
        if (typeof cv !== 'undefined' && cv.Mat) {
            try {
                let mat = cv.imread(canvas);
                cv.cvtColor(mat, mat, cv.ColorConversionCodes.COLOR_RGBA2GRAY); // ç°åº¦
                cv.convertScaleAbs(mat, mat, 1.25, 15); // å¢åŠ  25% å¯¹æ¯”åº¦
                cv.imshow(canvas, mat);
                mat.delete();
            } catch (e) { console.error("CV é¢„å¤„ç†å¤±è´¥", e); }
        }

        const base64Img = canvas.toDataURL('image/jpeg', 0.8);
        document.getElementById('loadingLayer').style.display = 'flex';

        // --- è°ƒç”¨ Qwen3-VL-Flash ---
        try {
            const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${DASH_KEY}`
                },
                body: JSON.stringify({
                    model: "qwen3-vl-flash",
                    messages: [{
                        role: "user",
                        content: [
                            { type: "text", text: "ä½œä¸ºé˜…å·åŠ©æ‰‹ï¼Œè¯·è¯†åˆ«è¿™å¼ ç­”é¢˜å¡ã€‚æå–å­¦ç”Ÿç­çº§ã€å§“åã€‚è¯†åˆ«å¬åŠ›ã€é˜…è¯»ã€å®Œå½¢å¡«ç©ºã€å¡«ç©ºé¢˜çš„å¾—åˆ†ã€‚å¦‚æœè¯†åˆ«ä¸åˆ°å¡«0ã€‚è¯·ä¸¥æ ¼è¿”å› JSONï¼š{\"class\":\"\",\"name\":\"\",\"listening\":0,\"reading\":0,\"cloze\":0,\"filling\":0}" },
                            { type: "image_url", image_url: { url: base64Img } }
                        ]
                    }],
                    response_format: { type: "json_object" }
                })
            });

            const resData = await response.json();
            const result = JSON.parse(resData.choices[0].message.content);
            appendRow(result);
        } catch (err) {
            alert("è¯†åˆ«å¤±è´¥: " + err.message);
        } finally {
            document.getElementById('loadingLayer').style.display = 'none';
        }
    }

    // 3. è¡¨æ ¼æ¸²æŸ“ä¸è‡ªåŠ¨åˆåˆ†
    function appendRow(data) {
        const tbody = document.querySelector('#mainTable tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td contenteditable="true">${data.class || '-'}</td>
            <td contenteditable="true">${data.name || '-'}</td>
            <td contenteditable="true" class="score-input">${data.listening || 0}</td>
            <td contenteditable="true" class="score-input">${data.reading || 0}</td>
            <td contenteditable="true" class="score-input">${data.cloze || 0}</td>
            <td contenteditable="true" class="score-input">${data.filling || 0}</td>
            <td contenteditable="true" class="score-input table-warning">0</td>
            <td class="total-score">0</td>
        `;
        tbody.appendChild(tr);

        // ç›‘å¬è¾“å…¥è‡ªåŠ¨è®¡ç®—
        tr.querySelectorAll('[contenteditable]').forEach(td => {
            td.oninput = () => calculateTotal(tr);
        });
        calculateTotal(tr);
        tr.scrollIntoView({ behavior: 'smooth' });
    }

    function calculateTotal(row) {
        let total = 0;
        row.querySelectorAll('.score-input').forEach(td => {
            total += parseFloat(td.innerText) || 0;
        });
        row.querySelector('.total-score').innerText = total;
    }

    // 4. å¯¼å‡º
    function exportExcel() {
        const wb = XLSX.utils.table_to_book(document.getElementById('mainTable'), {sheet: "æˆç»©æ±‡æ€»"});
        XLSX.writeFile(wb, `é˜…å·æŠ¥å‘Š_${new Date().toLocaleDateString()}.xlsx`);
    }
</script>

</body>
</html>
