
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½é˜…å·ç»ˆç«¯ - çœæµç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://docs.opencv.org/4.5.2/opencv.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { background: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .main-container { max-width: 1200px; margin: 30px auto; padding: 20px; }
        .card-custom { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); background: white; overflow: hidden; }
        .video-box { position: relative; width: 100%; padding-bottom: 75%; /* 4:3 Aspect Ratio */ background: #000; }
        #video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        /* API å¼¹çª—æ ·å¼ */
        #apiModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 450px; }
        /* Loading æ ·å¼ */
        #loadingToast { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; }
        .table-hover tbody tr:hover { background-color: #f8f9fa; }
        .score-cell { font-weight: 500; color: #2c3e50; }
        .total-cell { font-weight: 700; color: #0d6efd; background-color: #e9ecef; }
    </style>
</head>
<body>

<div id="apiModal">
    <div class="modal-box">
        <h5 class="mb-3">ğŸ”‘ éœ€è¦ API Key</h5>
        <p class="text-muted small mb-3">è¯·è¾“å…¥æ‚¨çš„é˜¿é‡Œäº‘ DashScope API Keyã€‚å¯†é’¥ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ã€‚</p>
        <input type="password" id="apiInput" class="form-control mb-3" placeholder="sk-..." autocomplete="off">
        <button class="btn btn-primary w-100" onclick="saveKey()">ä¿å­˜å¹¶å¯åŠ¨</button>
    </div>
</div>

<div id="loadingToast" class="toast align-items-center text-white bg-primary border-0 show" role="alert" aria-live="assertive" aria-atomic="true">
  <div class="d-flex">
    <div class="toast-body">
      <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
      AI æ­£åœ¨è¯†åˆ«ä¸æ‰¹æ”¹ä¸­...
    </div>
  </div>
</div>

<div class="container main-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">ğŸ“‘ AI æ™ºèƒ½é˜…å·ç³»ç»Ÿ <span class="badge bg-success" style="font-size: 0.5em; vertical-align: middle;">çœæµæ¨¡å¼</span></h3>
        <button class="btn btn-outline-secondary btn-sm" onclick="clearKey()">é€€å‡º/æ¢å·</button>
    </div>

    <div class="row g-4">
        <div class="col-md-5">
            <div class="card-custom p-3 h-100">
                <div class="video-box rounded mb-3">
                    <video id="video" autoplay playsinline></video>
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-lg" id="captureBtn" onclick="captureAndProcess()">ğŸ“¸ æ‹ç…§æ‰¹æ”¹</button>
                    <small class="text-muted text-center">æç¤ºï¼šè¯·ç¡®ä¿å…‰çº¿å……è¶³ï¼Œç­”é¢˜å¡å æ»¡ç”»é¢</small>
                </div>
                <canvas id="processCanvas" style="display:none;"></canvas>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card-custom p-4 h-100 d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="m-0">æ‰¹æ”¹ç»“æœæ±‡æ€»</h5>
                    <button class="btn btn-success btn-sm" onclick="exportExcel()">ğŸ“Š å¯¼å‡º Excel</button>
                </div>
                <div class="table-responsive flex-grow-1">
                    <table class="table table-hover align-middle" id="resultTable">
                        <thead class="table-light small text-muted">
                            <tr>
                                <th>ç­çº§</th>
                                <th>å§“å</th>
                                <th>å¬åŠ›</th>
                                <th>é˜…è¯»</th>
                                <th>å®Œå½¢</th>
                                <th>å¡«ç©º</th>
                                <th>ä½œæ–‡(æ‰‹å†™)</th>
                                <th>æ€»åˆ†</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('processCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    let apiKey = localStorage.getItem('QWEN_API_KEY');

    // --- 1. åˆå§‹åŒ–ä¸å®‰å…¨æ£€æŸ¥ ---
    window.onload = checkAuth;

    function checkAuth() {
        if (!apiKey) {
            document.getElementById('apiModal').style.display = 'flex';
        } else {
            startCamera();
        }
    }

    function saveKey() {
        const inputVal = document.getElementById('apiInput').value.trim();
        if (inputVal.startsWith('sk-')) {
            localStorage.setItem('QWEN_API_KEY', inputVal);
            apiKey = inputVal;
            document.getElementById('apiModal').style.display = 'none';
            startCamera();
        } else {
            alert("API Key æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä»¥ sk- å¼€å¤´");
        }
    }

    function clearKey() {
        if (confirm("ç¡®å®šè¦æ¸…é™¤æœ¬åœ°å¯†é’¥å¹¶é€€å‡ºå—ï¼Ÿ")) {
            localStorage.removeItem('QWEN_API_KEY');
            location.reload();
        }
    }

    // --- 2. æ‘„åƒå¤´æ§åˆ¶ ---
    async function startCamera() {
        try {
            // å°è¯•è¯·æ±‚é«˜æ¸…åç½®æ‘„åƒå¤´
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } }
            });
            video.srcObject = stream;
        } catch (err) {
            alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: " + err.message + "\nè¯·ç¡®ä¿ä½¿ç”¨ HTTPS æˆ– localhost è®¿é—®ã€‚");
        }
    }

    // --- 3. æ ¸å¿ƒï¼šæ‹ç…§ã€å‹ç¼©ä¸ AI å¤„ç† ---
    async function captureAndProcess() {
        if (!apiKey || video.readyState !== 4) return;

        // --- å…³é”®ä¼˜åŒ–ï¼šæ™ºèƒ½é™é‡‡æ · (Token çœæµæ ¸å¿ƒ) ---
        const MAX_DIMENSION = 1024; // è®¾ç½®æœ€å¤§è¾¹é•¿ä¸º 1024px
        let w = video.videoWidth;
        let h = video.videoHeight;
        let scale = 1;

        if (w > MAX_DIMENSION || h > MAX_DIMENSION) {
            scale = w > h ? MAX_DIMENSION / w : MAX_DIMENSION / h;
        }
        
        // è®¾ç½®ç”»å¸ƒä¸ºç¼©å°åçš„å°ºå¯¸
        canvas.width = w * scale;
        canvas.height = h * scale;
        // å°†è§†é¢‘å¸§ç»˜åˆ¶åˆ°ç”»å¸ƒä¸Š (æµè§ˆå™¨ä¼šè‡ªåŠ¨è¿›è¡Œå¹³æ»‘ç¼©æ”¾)
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // --- OpenCV å›¾åƒå¢å¼º (åœ¨ç¼©å°åçš„å›¾åƒä¸Šå¤„ç†ï¼Œé€Ÿåº¦æ›´å¿«) ---
        if (typeof cv !== 'undefined' && cv.Mat) {
            try {
                let src = cv.imread(canvas);
                // è½¬ç°åº¦
                cv.cvtColor(src, src, cv.ColorConversionCodes.COLOR_RGBA2GRAY);
                // å¢åŠ å¯¹æ¯”åº¦ (Alpha=1.3, Beta=15) è®©å­—è¿¹æ›´é»‘ï¼Œçº¸å¼ æ›´ç™½
                cv.convertScaleAbs(src, src, 1.3, 15);
                // å°†å¤„ç†åçš„å›¾åƒæ˜¾ç¤ºå›ç”»å¸ƒ
                cv.imshow(canvas, src);
                src.delete();
            } catch (e) {
                console.warn("OpenCV å¤„ç†å¤±è´¥ï¼Œå°†ä½¿ç”¨åŸå›¾:", e);
            }
        }

        // --- å¯¼å‡º Base64 (é€‚åº¦ JPEG å‹ç¼©) ---
        // quality 0.75 æ˜¯ä½“ç§¯å’Œæ¸…æ™°åº¦çš„ç»ä½³å¹³è¡¡ç‚¹
        const base64Image = canvas.toDataURL('image/jpeg', 0.75);

        // --- è°ƒç”¨ AI ---
        toggleLoading(true);
        try {
            const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: "qwen3-vl-flash", // å»ºè®®ä½¿ç”¨ max ä»¥ä¿è¯åœ¨å‹ç¼©å›¾ç‰‡ä¸‹çš„è¯†åˆ«ç‡
                    messages: [{
                        role: "user",
                        content: [
                            { type: "text", text: "ä½ æ˜¯ä¸€ä¸ªé˜…å·å‘˜ã€‚åˆ†æè¿™å¼ ç­”é¢˜å¡å›¾åƒã€‚æå–ï¼šç­çº§ã€å§“åã€‚è¯†åˆ«å„å¤§é¢˜å¾—åˆ†ï¼šå¬åŠ›ã€é˜…è¯»ã€å®Œå½¢ã€å¡«ç©ºã€‚æ³¨æ„ï¼šå¦‚æœæŸé¡¹æ²¡æœ‰å¾—åˆ†æˆ–æœªè¯†åˆ«åˆ°ï¼Œè¯·å¡« 0ã€‚è¯·ä»…è¿”å›çº¯ JSON æ•°æ®ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š{"class":"","name":"","listening":0,"reading":0,"cloze":0,"filling":0}" },
                            { type: "image_url", image_url: { url: base64Image } }
                        ]
                    }]
                })
            });

            if (!response.ok) throw new Error(`API Error ${response.status}`);
            
            const data = await response.json();
            let content = data.choices[0].message.content;
            // æ¸…ç†å¯èƒ½å­˜åœ¨çš„ Markdown æ ‡è®°
            content = content.replace(/```json|```/g, '').trim();
            const resultData = JSON.parse(content);
            
            addResultRow(resultData);

        } catch (err) {
            console.error(err);
            alert("æ‰¹æ”¹å¤±è´¥: " + err.message + "\nå¦‚æœæ˜¯è·¨åŸŸé—®é¢˜ï¼Œè¯·æ£€æŸ¥ç½‘ç»œç¯å¢ƒã€‚");
        } finally {
            toggleLoading(false);
        }
    }

    // --- 4. è¡¨æ ¼æ“ä½œ ---
    function addResultRow(data) {
        const tbody = document.querySelector('#resultTable tbody');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td contenteditable="true">${data.class || '-'}</td>
            <td contenteditable="true">${data.name || '-'}</td>
            <td contenteditable="true" class="score-cell">${data.listening || 0}</td>
            <td contenteditable="true" class="score-cell">${data.reading || 0}</td>
            <td contenteditable="true" class="score-cell">${data.cloze || 0}</td>
            <td contenteditable="true" class="score-cell">${data.filling || 0}</td>
            <td contenteditable="true" class="score-cell bg-warning bg-opacity-10" style="outline: 2px solid #ffc107;">0</td>
            <td class="total-cell">0</td>
        `;
        tbody.appendChild(row);
        
        // ä¸ºæ‰€æœ‰åˆ†æ•°å•å…ƒæ ¼æ·»åŠ å®æ—¶è®¡ç®—ç›‘å¬
        const scoreCells = row.querySelectorAll('.score-cell');
        scoreCells.forEach(cell => {
            cell.addEventListener('input', () => calculateTotal(row));
        });
        // åˆå§‹è®¡ç®—ä¸€æ¬¡
        calculateTotal(row);
        // æ»šåŠ¨åˆ°æœ€æ–°è¡Œ
        row.scrollIntoView({ behavior: 'smooth' });
    }

    function calculateTotal(row) {
        let total = 0;
        row.querySelectorAll('.score-cell').forEach(cell => {
            // å¤„ç†éæ•°å­—è¾“å…¥ï¼Œé¿å… NaN
            let val = parseFloat(cell.innerText.trim());
            total += isNaN(val) ? 0 : val;
        });
        row.querySelector('.total-cell').innerText = total;
    }

    function exportExcel() {
        const table = document.getElementById('resultTable');
        // ä½¿ç”¨ SheetJS å°†è¡¨æ ¼è½¬æ¢ä¸ºå·¥ä½œç°¿
        const wb = XLSX.utils.table_to_book(table, {sheet: "æˆç»©å•"});
        // ç”Ÿæˆæ–‡ä»¶å
        const date = new Date().toISOString().slice(0,10).replace(/-/g,'');
        XLSX.writeFile(wb, `é˜…å·æˆç»©å¯¼å‡º_${date}.xlsx`);
    }

    function toggleLoading(show) {
        document.getElementById('loadingToast').style.display = show ? 'block' : 'none';
        document.getElementById('captureBtn').disabled = show;
    }
</script>

</body>
</html>
