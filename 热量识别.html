<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI è¥å…»å¸ˆ (Qwen3-VL)</title>
    <style>
        :root { --primary: #27ae60; --bg: #f8f9fa; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; }
        
        /* è§†é¢‘é¢„è§ˆåŒº */
        #video-container { width: 100%; max-height: 60vh; background: #000; overflow: hidden; position: relative; line-height: 0; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* UI äº¤äº’åŒº */
        .controls { padding: 25px; width: 100%; max-width: 500px; box-sizing: border-box; }
        #captureBtn { 
            background: var(--primary); color: white; border: none; padding: 18px; 
            border-radius: 12px; font-size: 18px; font-weight: bold; width: 100%;
            box-shadow: 0 4px 12px rgba(39,174,96,0.3); cursor: pointer;
        }
        #captureBtn:active { transform: scale(0.98); opacity: 0.9; }
        #captureBtn:disabled { background: #bdc3c7; box-shadow: none; }

        /* ç»“æœå±•ç¤ºåŒº */
        #result-card { 
            margin-top: 20px; background: white; padding: 20px; border-radius: 16px; 
            display: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 100%;
        }
        .loading-text { display: none; color: var(--primary); font-weight: bold; margin: 15px 0; }
        
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; }
        .total-box { background: #eef9f1; padding: 10px; border-radius: 8px; font-weight: bold; color: #1e8449; }
    </style>
</head>
<body>

<div id="video-container">
    <video id="video" autoplay playsinline></video>
</div>

<div class="controls">
    <button id="captureBtn">ğŸ“· æ‹ç…§è¯†åˆ«çƒ­é‡</button>
    <div id="loader" class="loading-text">ğŸš€ Qwen3-VL æ­£åœ¨æ·±åº¦åˆ†æå›¾ç‰‡...</div>

    <div id="result-card">
        <h3 style="margin-top:0; color:#333;">è¯†åˆ«æŠ¥å‘Š</h3>
        <div id="content-area"></div>
    </div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const resultCard = document.getElementById('result-card');
    const loader = document.getElementById('loader');
    const contentArea = document.getElementById('content-area');

    // 1. åˆå§‹åŒ–æ‘„åƒå¤´ (ç¯å¢ƒæ‘„åƒå¤´)
    async function init() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" }, 
                audio: false 
            });
            video.srcObject = stream;
        } catch (err) {
            alert("æ— æ³•æ‰“å¼€æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿ä½¿ç”¨ HTTPS è®¿é—®å¹¶å…è®¸æƒé™");
        }
    }

    // 2. æ ¸å¿ƒåŠŸèƒ½ï¼šå‹ç¼©å¹¶å‘é€è¯·æ±‚
    captureBtn.addEventListener('click', async () => {
        const ctx = canvas.getContext('2d');
        
        // è‡ªåŠ¨å‹ç¼©ï¼šé™åˆ¶æœ€å¤§å®½åº¦ä¸º 1000pxï¼Œé˜²æ­¢è¯·æ±‚ä½“è¿‡å¤§
        const MAX_WIDTH = 1000;
        const scale = Math.min(1, MAX_WIDTH / video.videoWidth);
        canvas.width = video.videoWidth * scale;
        canvas.height = video.videoHeight * scale;
        
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const base64Image = canvas.toDataURL('image/jpeg', 0.7); // è´¨é‡è®¾ä¸º 0.7

        // æ›´æ–° UI çŠ¶æ€
        loader.style.display = 'block';
        resultCard.style.display = 'none';
        captureBtn.disabled = true;

        try {
            const response = await fetch('[https://nekosensei-aiapi.2367372529.workers.dev](https://nekosensei-aiapi.2367372529.workers.dev)', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    provider: "qwen",
                    model: "qwen3-vl-plus", // æ˜ç¡®æŒ‡å®šæ¨¡å‹
                    messages: [
                        {
                            role: "user",
                            content: [
                                { type: "text", text: "è¯·è¯†åˆ«å›¾ç‰‡ä¸­çš„é£Ÿç‰©ã€‚åªè¾“å‡º JSON å¯¹è±¡ï¼Œä¸¥ç¦åŒ…å« ``` æ ‡ç­¾ã€‚æ ¼å¼ï¼š{\"items\":[{\"name\":\"åç§°\",\"kcal\":100,\"weight\":\"100g\"}],\"total_kcal\":100,\"advice\":\"å»ºè®®\"}" },
                                { type: "image_url", image_url: { url: base64Image } }
                            ]
                        }
                    ]
                })
            });

            const rawText = await response.text();
            console.log("Raw Response:", rawText);

            // æ¸…æ´—å¹¶è§£æ JSON
            const cleanJson = rawText.replace(/```json|```/g, '').trim();
            const data = JSON.parse(cleanJson);
            
            // å¤„ç†ä¸åŒ Worker çš„è¿”å›ç»“æ„
            const aiRawContent = data.choices ? data.choices[0].message.content : (data.output?.choices[0].message.content[0].text || JSON.stringify(data));
            
            renderUI(aiRawContent);
        } catch (err) {
            console.error(err);
            alert("åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ§åˆ¶å°æ—¥å¿—ã€‚å†…å®¹ï¼š" + err.message);
        } finally {
            loader.style.display = 'none';
            captureBtn.disabled = false;
        }
    });

    // 3. æ¸²æŸ“ç»“æœåˆ°é¡µé¢
    function renderUI(content) {
        try {
            // å¦‚æœ content è¿˜æ˜¯å­—ç¬¦ä¸²ï¼Œå†è§£æä¸€æ¬¡
            const res = typeof content === 'string' ? JSON.parse(content.replace(/```json|```/g, '').trim()) : content;
            
            let tableHtml = `<table><tr><th>é£Ÿç‰©</th><th>ä¼°é‡</th><th>çƒ­é‡</th></tr>`;
            res.items.forEach(i => {
                tableHtml += `<tr><td>${i.name}</td><td>${i.weight}</td><td>${i.kcal} kcal</td></tr>`;
            });
            tableHtml += `</table>`;
            tableHtml += `<div class="total-box">æ€»è®¡çƒ­é‡ï¼š${res.total_kcal} kcal</div>`;
            tableHtml += `<p style="font-size:13px; color:#666; line-height:1.5;">ğŸ’¡ ${res.advice}</p>`;
            
            contentArea.innerHTML = tableHtml;
            resultCard.style.display = 'block';
        } catch (e) {
            contentArea.innerHTML = `<p>è§£æå¤±è´¥ï¼ŒAI è¿”å›åŸæ–‡ï¼š</p><pre style="font-size:10px; background:#f0f0f0; padding:10px; overflow:auto;">${content}</pre>`;
            resultCard.style.display = 'block';
        }
    }

    init();
</script>
</body>
</html>
