<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI æ™ºèƒ½è¯†é¤</title>
    <style>
        :root { --primary: #007AFF; --bg: #f5f5f7; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        #video-container { width: 100%; position: relative; background: #000; line-height: 0; }
        video { width: 100%; height: auto; max-height: 70vh; object-fit: cover; }
        .ui-layer { padding: 20px; width: 90%; max-width: 500px; text-align: center; }
        #captureBtn { background: var(--primary); color: white; border: none; padding: 16px 32px; border-radius: 50px; font-size: 18px; font-weight: 600; box-shadow: 0 4px 15px rgba(0,122,255,0.3); cursor: pointer; transition: transform 0.1s; width: 100%; }
        #captureBtn:active { transform: scale(0.95); }
        #captureBtn:disabled { background: #ccc; box-shadow: none; }
        #result { margin-top: 20px; background: white; padding: 20px; border-radius: 16px; text-align: left; display: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .loading { display: none; color: #666; margin: 15px 0; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; font-size: 14px; }
    </style>
</head>
<body>

<div id="video-container">
    <video id="video" autoplay playsinline></video>
</div>

<div class="ui-layer">
    <button id="captureBtn">ç‚¹å‡»æ‹ç…§è¯†åˆ«</button>
    <div class="loading" id="loader">âœ¨ AI æ­£åœ¨è®¡ç®—å¡è·¯é‡Œ...</div>
    
    <div id="result">
        <h3 style="margin-top:0">åˆ†æç»“æœ</h3>
        <div id="jsonContent"></div>
    </div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const resultDiv = document.getElementById('result');
    const loader = document.getElementById('loader');
    const jsonContent = document.getElementById('jsonContent');

    // 1. å¯åŠ¨æ‘„åƒå¤´
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: { ideal: 1280 } }, 
                audio: false 
            });
            video.srcObject = stream;
        } catch (err) {
            alert("è¯·ç¡®ä¿åœ¨ HTTPS ç¯å¢ƒä¸‹è¿è¡Œå¹¶æˆäºˆæ‘„åƒå¤´æƒé™");
        }
    }

    // 2. æ ¸å¿ƒé€»è¾‘ï¼šæ‹ç…§å¹¶è°ƒç”¨ Cloudflare Worker
    captureBtn.addEventListener('click', async () => {
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        const base64Image = canvas.toDataURL('image/jpeg', 0.8);
        
        // UI çŠ¶æ€åˆ‡æ¢
        loader.style.display = 'block';
        resultDiv.style.display = 'none';
        captureBtn.disabled = true;

        try {
            const response = await fetch('[https://nekosensei-aiapi.2367372529.workers.dev](https://nekosensei-aiapi.2367372529.workers.dev)', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    provider: "qwen",
                    messages: [
                        {
                            role: "user",
                            content: [
                                { type: "text", text: "è¯·åˆ†æè¿™å¼ å›¾ç‰‡ä¸­çš„é£Ÿç‰©ã€‚è¯·åªè¾“å‡º JSON æ ¼å¼çš„ç»“æœï¼Œä¸è¦åŒ…å« Markdown ä»£ç å—æˆ–ä»»ä½•è§£é‡Šè¯´æ˜æ–‡å­—ã€‚æ ¼å¼å¿…é¡»ä¸ºï¼š{\"items\": [{\"name\": \"é£Ÿç‰©åç§°\", \"kcal\": \"çƒ­é‡\", \"weight\": \"ä¼°ç®—é‡é‡\"}], \"total_kcal\": \"æ€»çƒ­é‡\", \"advice\": \"ä¸€å¥è¯å»ºè®®\"}" },
                                { type: "image_url", image_url: { url: base64Image } }
                            ]
                        }
                    ]
                })
            });

            const data = await response.json();
            // å‡è®¾ä½ çš„ Worker è¿”å›çš„æ•°æ®ç»“æ„ç¬¦åˆ OpenAI è§„èŒƒï¼šdata.choices[0].message.content
            const content = data.choices ? data.choices[0].message.content : data.output.choices[0].message.content[0].text;
            
            renderResult(content);
        } catch (err) {
            alert("åˆ†æå¤±è´¥: " + err.message);
        } finally {
            loader.style.display = 'none';
            captureBtn.disabled = false;
        }
    });

    // 3. è§£æå¹¶æ¸²æŸ“ JSON ç»“æœ
    function renderResult(rawJson) {
        try {
            // æ¸…ç†å¯èƒ½å­˜åœ¨çš„ Markdown æ ‡ç­¾ï¼ˆä¸‡ä¸€ AI æ²¡å¬è¯ï¼‰
            const cleanJson = rawJson.replace(/```json|```/g, '').trim();
            const res = JSON.parse(cleanJson);
            
            let html = `<table><tr><th>åç§°</th><th>é‡é‡</th><th>çƒ­é‡</th></tr>`;
            res.items.forEach(item => {
                html += `<tr><td>${item.name}</td><td>${item.weight}</td><td>${item.kcal}</td></tr>`;
            });
            html += `</table><p><strong>æ€»è®¡ï¼š${res.total_kcal}</strong></p>`;
            html += `<p style="color:#666; font-size:12px;">ğŸ’¡å»ºè®®ï¼š${res.advice}</p>`;
            
            jsonContent.innerHTML = html;
            resultDiv.style.display = 'block';
        } catch (e) {
            jsonContent.innerHTML = `<pre style="white-space:pre-wrap;">${rawJson}</pre>`;
            resultDiv.style.display = 'block';
        }
    }

    startCamera();
</script>

</body>
</html>