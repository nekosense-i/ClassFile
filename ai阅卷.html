<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NekoSensei ä¸“ä¸šé˜…å·ç«™</title>
    <style>
        :root { --ios-blue: #007aff; --ios-orange: #ff9500; --ios-bg: #f2f2f7; }
        body { font-family: -apple-system, sans-serif; background: var(--ios-bg); margin: 0; padding: 15px; overflow-x: hidden; }
        
        /* æ‰«æå®¹å™¨ */
        .scanner-container { position: relative; width: 100%; border-radius: 20px; overflow: hidden; background: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        video { width: 100%; display: block; }
        
        /* è¾…åŠ©å¯¹ç„¦æ¡† */
        .scan-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            pointer-events: none;
        }
        .scan-box {
            width: 80%; height: 80%; border: 2px solid rgba(255,255,255,0.8);
            box-shadow: 0 0 0 5000px rgba(0,0,0,0.5); /* é®ç½©å±‚ */
            border-radius: 10px; position: relative;
        }
        .scan-box::after {
            content: "è¯·å°†ç­”é¢˜å¡å¯¹å‡†æ­¤æ¡†"; position: absolute; bottom: -30px;
            width: 100%; text-align: center; color: white; font-size: 14px;
        }

        /* æˆç»©è¡¨å¡ç‰‡ */
        .card { background: white; border-radius: 18px; padding: 20px; margin-top: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #eee; padding: 12px 8px; text-align: center; font-size: 13px; }
        th { background: #fafafa; color: #8e8e93; font-weight: 500; }
        .editable { color: var(--ios-blue); font-weight: 600; outline: none; background: #f0f7ff; }
        .essay-input { color: var(--ios-orange); background: #fff9f0; }
        .total-font { font-size: 20px; font-weight: 800; background: #f2f2f7; }

        .btn-main {
            width: 100%; padding: 18px; background: var(--ios-blue); color: white;
            border: none; border-radius: 15px; font-size: 18px; font-weight: 600;
            margin-top: 15px; cursor: pointer; transition: 0.3s;
        }
        .btn-main:active { transform: scale(0.98); opacity: 0.9; }
        #log { text-align: center; font-size: 13px; color: #8e8e93; margin-top: 10px; }
    </style>
</head>
<body>

<div class="scanner-container">
    <video id="video" autoplay playsinline></video>
    <div class="scan-overlay">
        <div class="scan-box" id="scanBox"></div>
    </div>
</div>

<button class="btn-main" onclick="captureAndGrade()">ğŸ“¸ æ‹ç…§å¹¶æ™ºèƒ½æ‰¹æ”¹</button>
<div id="log">æ­£åœ¨åˆå§‹åŒ–æ‘„åƒå¤´...</div>

<div class="card">
    <h3 style="margin-top:0">ğŸ“Š å®æ—¶æˆç»©æ±‡æ€»</h3>
    <table>
        <thead>
            <tr>
                <th>ç­çº§</th><th>å§“å</th><th>å¬åŠ›</th><th>é˜…è¯»</th><th>å®Œå‹</th><th>å¡«ç©º</th><th style="color:var(--ios-orange)">ä½œæ–‡</th><th>æ€»åˆ†</th>
            </tr>
        </thead>
        <tbody id="scoreTableBody">
            <tr>
                <td id="t-class" contenteditable="true">-</td>
                <td id="t-name" contenteditable="true">-</td>
                <td id="t-listening" class="editable" contenteditable="true">0</td>
                <td id="t-reading" class="editable" contenteditable="true">0</td>
                <td id="t-cloze" class="editable" contenteditable="true">0</td>
                <td id="t-grammar" class="editable" contenteditable="true">0</td>
                <td id="t-essay" class="editable essay-input" contenteditable="true">0</td>
                <td id="t-total" class="total-font">0</td>
            </tr>
        </tbody>
    </table>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
    let API_KEY = localStorage.getItem('nekosensei_key') || prompt("è¯·è¾“å…¥ API Key:");
    if(API_KEY) localStorage.setItem('nekosensei_key', API_KEY);

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // 1. åˆå§‹åŒ–é«˜æ¸…æ‘„åƒå¤´
    navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } } 
    }).then(stream => { 
        video.srcObject = stream;
        document.getElementById('log').innerText = "å·²å°±ç»ªï¼Œè¯·å¯¹å‡†è¯•å·";
    });

    async function captureAndGrade() {
        const log = document.getElementById('log');
        log.innerText = "â³ æ­£åœ¨è¿›è¡Œå¢å¼ºå¤„ç†å¹¶æ‰¹æ”¹...";

        // 2. å›¾åƒè£å‰ªé€»è¾‘ï¼šåªæå–æ‰«ææ¡†å†…çš„å†…å®¹
        const videoW = video.videoWidth;
        const videoH = video.videoHeight;
        
        // å‡è®¾æ¡†å  80%
        const cropW = videoW * 0.8;
        const cropH = videoH * 0.8;
        const startX = (videoW - cropW) / 2;
        const startY = (videoH - cropH) / 2;

        canvas.width = cropW;
        canvas.height = cropH;

        // 3. åº”ç”¨å›¾åƒå¢å¼ºæ»¤é•œ
        ctx.filter = "grayscale(100%) contrast(150%) brightness(110%)";
        
        // 4. ç»˜åˆ¶å¹¶è£å‰ª
        ctx.drawImage(video, startX, startY, cropW, cropH, 0, 0, cropW, cropH);
        
        const base64Img = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

        // 5. è°ƒç”¨ API (æ­¤å¤„ä¿æŒä¹‹å‰çš„ fetch é€»è¾‘)
        try {
            const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${API_KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: "deepseek-vl2",
                    messages: [{
                        role: "user",
                        content: [
                            { type: "text", text: "è¯†åˆ«è¿™å¼ æ—¥è¯­ç­”é¢˜å¡ï¼Œè¿”å›JSONæ ¼å¼ï¼šclass, name, listening, reading, cloze, grammar" },
                            { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64Img}` } }
                        ]
                    }],
                    response_format: { type: "json_object" }
                })
            });
            const res = await response.json();
            const data = JSON.parse(res.choices[0].message.content);
            
            // å¡«å……æ•°æ®
            fillTable(data);
            log.innerText = "âœ… æ‰¹æ”¹å®Œæˆï¼";
        } catch (e) {
            log.innerText = "âŒ è¯†åˆ«å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– Key";
        }
    }

    function fillTable(data) {
        document.getElementById('t-class').innerText = data.class || "-";
        document.getElementById('t-name').innerText = data.name || "-";
        document.getElementById('t-listening').innerText = data.listening || 0;
        document.getElementById('t-reading').innerText = data.reading || 0;
        document.getElementById('t-cloze').innerText = data.cloze || 0;
        document.getElementById('t-grammar').innerText = data.grammar || 0;
        updateTotal();
    }

    function updateTotal() {
        const ids = ['listening', 'reading', 'cloze', 'grammar', 'essay'];
        let sum = 0;
        ids.forEach(id => {
            sum += parseFloat(document.getElementById('t-' + id).innerText) || 0;
        });
        document.getElementById('t-total').innerText = sum.toFixed(1);
    }

    // ç›‘å¬æ‰‹åŠ¨ä¿®æ”¹
    document.getElementById('scoreTableBody').addEventListener('input', updateTotal);
</script>
</body>
</html>