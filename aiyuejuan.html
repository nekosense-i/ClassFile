
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ—¥è¯­é˜…å·ä¸“ä¸šç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://docs.opencv.org/4.5.2/opencv.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary-color: #0d6efd; --bg-light: #f1f3f5; }
        body { background-color: var(--bg-light); font-family: 'Segoe UI', system-ui, sans-serif; }
        .app-container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; }
        .camera-card { border: none; border-radius: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: #fff; overflow: hidden; }
        .video-container { position: relative; background: #000; width: 100%; aspect-ratio: 210 / 297; margin: 0 auto; display: flex; align-items: center; justify-content: center; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        #answerStatus { font-size: 0.8rem; border-radius: 20px; padding: 5px 15px; display: inline-block; cursor: pointer; border: 1px solid transparent; }
        .status-none { background: #fff3f3; color: #d32f2f; border-color: #ffcdd2; }
        .status-ready { background: #f1f8e9; color: #388e3c; border-color: #c8e6c9; }
        .table-card { border: none; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); background: #fff; padding: 1.5rem; }
        .btn-delete { color: #dc3545; border: none; background: none; font-size: 1.1rem; }
        #apiOverlay, #answerModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; backdrop-filter: blur(8px); justify-content: center; align-items: center; }
        .modal-box { background: #fff; padding: 2rem; border-radius: 1.2rem; width: 90%; max-width: 550px; }
        #loadingLayer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9000; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="apiOverlay">
    <div class="modal-box text-center">
        <h4 class="fw-bold mb-3">ğŸ”‘ API é…ç½®</h4>
        <input type="password" id="apiKeyInput" class="form-control form-control-lg mb-4 text-center" placeholder="è¯·è¾“å…¥å¯†é’¥">
        <button class="btn btn-primary btn-lg w-100" onclick="saveKey()">ä¿å­˜å¹¶å¼€å¯</button>
    </div>
</div>

<div id="answerModal">
    <div class="modal-box shadow-lg">
        <h5 class="fw-bold mb-3">ğŸ¯ ç­”æ¡ˆé¢„è§ˆ</h5>
        <div id="answerContent" class="p-3 bg-light rounded mb-4 small" style="white-space: pre-wrap; max-height: 400px; overflow-y: auto;"></div>
        <div class="d-flex gap-2">
            <button class="btn btn-secondary w-100" onclick="closeAnswerModal()">è¿”å›</button>
            <button class="btn btn-outline-danger w-100" onclick="clearAnswers()">é‡å½•</button>
        </div>
    </div>
</div>

<div id="loadingLayer">
    <div class="spinner-border text-primary mb-3" style="width: 3.5rem; height: 3.5rem;"></div>
    <h5 id="loadingText" class="fw-bold text-primary">AI æ­£åœ¨å¤„ç†...</h5>
</div>

<div class="app-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div><h2 class="fw-bold mb-1">ğŸ“– AI é˜…å·ç»ˆç«¯</h2><div id="answerStatus" class="status-none" onclick="previewAnswers()">âš ï¸ å°šæœªå½•å…¥ç­”æ¡ˆ</div></div>
        <div><button class="btn btn-outline-danger btn-sm" onclick="fullReset()">é‡ç½®</button><button class="btn btn-success ms-2" onclick="exportExcel()">ğŸ“Š å¯¼å‡º</button></div>
    </div>
    <div class="row g-4">
        <div class="col-lg-5">
            <div class="camera-card">
                <div class="video-container"><video id="video" autoplay playsinline muted></video></div>
                <div class="p-3 bg-white"><div class="row g-2">
                    <div class="col-6"><button class="btn btn-warning btn-lg w-100 py-3 fw-bold" id="btnKey" onclick="handleScan('KEY')">ğŸ¯ 1. å½•å…¥ç­”æ¡ˆ</button></div>
                    <div class="col-6"><button class="btn btn-primary btn-lg w-100 py-3 fw-bold" id="btnStudent" onclick="handleScan('STUDENT')">ğŸ“ 2. æ‰¹æ”¹å­¦ç”Ÿ</button></div>
                </div></div>
            </div>
            <canvas id="hiddenCanvas" style="display:none;"></canvas>
        </div>
        <div class="col-lg-7"><div class="table-card"><div class="table-responsive"><table class="table table-hover align-middle" id="mainTable">
            <thead class="table-light"><tr><th>ç­çº§</th><th>å§“å</th><th>å¬åŠ›</th><th>é˜…è¯»</th><th>å®Œå½¢</th><th>å¡«ç©º</th><th class="table-warning">ä½œæ–‡</th><th>æ€»åˆ†</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
        </table></div></div></div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('hiddenCanvas');
    const ctx = canvas.getContext('2d');
    let appState = { apiKey: localStorage.getItem('ALI_QWEN_KEY'), savedConfig: JSON.parse(localStorage.getItem('SAVED_CONFIG')), records: JSON.parse(localStorage.getItem('STUDENT_RECORDS')) || [] };
    
    window.onload = () => { if (!appState.apiKey) document.getElementById('apiOverlay').style.display = 'flex'; else { initApp(); renderSavedData(); } };
    function saveKey() { const val = document.getElementById('apiKeyInput').value.trim(); if (val.startsWith('sk-')) { localStorage.setItem('ALI_QWEN_KEY', val); location.reload(); } }
    async function initApp() { try { const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: 1280, height: 720 } }); video.srcObject = s; updateAnswerStatus(); } catch (e) { alert("æ‘„åƒå¤´å¤±è´¥"); } }
    function renderSavedData() { const b = document.querySelector('#mainTable tbody'); b.innerHTML = ""; appState.records.forEach((r, i) => appendRow(r, i)); }
    function updateAnswerStatus() { const s = document.getElementById('answerStatus'); s.innerText = appState.savedConfig ? "âœ… ç­”æ¡ˆå°±ç»ª" : "âš ï¸ å°šæœªå½•å…¥"; s.className = appState.savedConfig ? "status-ready" : "status-none"; }
    
    async function handleScan(mode) {
        if (mode === 'STUDENT' && !appState.savedConfig) return alert("å…ˆæ‰«ç­”æ¡ˆå¡ï¼");
        document.getElementById('btnKey').disabled = true;
        document.getElementById('btnStudent').disabled = true;
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        document.getElementById('loadingLayer').style.display = 'flex';
        try { await executeAi(mode); } catch (e) { alert("è¯†åˆ«å‡ºé”™"); }
        finally { document.getElementById('loadingLayer').style.display = 'none'; document.getElementById('btnKey').disabled = false; document.getElementById('btnStudent').disabled = false; video.play(); }
    }

    async function executeAi(mode) {
        const img = canvas.toDataURL('image/jpeg', 0.8);
        const p = mode === 'KEY' ? "è¯†åˆ«å¡«æ¶‚æœ€é»‘çš„ä½œä¸ºç­”æ¡ˆå¡å¹¶è¿”å›JSON" : `å‚è€ƒç­”æ¡ˆï¼š\${JSON.stringify(appState.savedConfig)}ï¼Œè¯†åˆ«æœ€é»‘å¡«æ¶‚å¹¶æ‰¹æ”¹è¿”å›JSON`;
        const r = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer \${appState.apiKey}` },
            body: JSON.stringify({ model: "qwen3-vl-flash", messages: [{ role: "user", content: [{ type: "text", text: p }, { type: "image_url", image_url: { url: img } }] }], response_format: { type: "json_object" } })
        });
        const d = await r.json(); const res = JSON.parse(d.choices[0].message.content);
        if (mode === 'KEY') { appState.savedConfig = res; localStorage.setItem('SAVED_CONFIG', JSON.stringify(res)); updateAnswerStatus(); }
        else { appState.records.push(res); localStorage.setItem('STUDENT_RECORDS', JSON.stringify(appState.records)); renderSavedData(); }
    }

    function appendRow(d, i) {
        const b = document.querySelector('#mainTable tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>\${d.class||'-'}</td><td>\${d.name||'-'}</td><td contenteditable="true" oninput="update(\${i},'listening',this)">\${d.listening||0}</td><td contenteditable="true" oninput="update(\${i},'reading',this)">\${d.reading||0}</td><td contenteditable="true" oninput="update(\${i},'cloze',this)">\${d.cloze||0}</td><td contenteditable="true" oninput="update(\${i},'filling',this)">\${d.filling||0}</td><td contenteditable="true" class="table-warning" oninput="update(\${i},'essay',this)">0</td><td class="total">0</td><td><button onclick="del(\${i})">ğŸ—‘ï¸</button></td>`;
        b.appendChild(tr); calc(tr);
    }
    function update(i, f, e) { appState.records[i][f] = parseFloat(e.innerText)||0; localStorage.setItem('STUDENT_RECORDS', JSON.stringify(appState.records)); calc(e.closest('tr')); }
    function calc(r) { let t = 0; r.querySelectorAll('td[contenteditable]').forEach(c => t += parseFloat(c.innerText)||0); r.querySelector('.total').innerText = t; }
    function del(i) { if(confirm("åˆ é™¤ï¼Ÿ")) { appState.records.splice(i, 1); localStorage.setItem('STUDENT_RECORDS', JSON.stringify(appState.records)); renderSavedData(); } }
    function previewAnswers() { if(!appState.savedConfig) return; document.getElementById('answerContent').innerText = JSON.stringify(appState.savedConfig, null, 2); document.getElementById('answerModal').style.display = 'flex'; }
    function closeAnswerModal() { document.getElementById('answerModal').style.display = 'none'; }
    function clearAnswers() { if(confirm("æ¸…é™¤ï¼Ÿ")) { appState.savedConfig = null; localStorage.removeItem('SAVED_CONFIG'); updateAnswerStatus(); closeAnswerModal(); } }
    function fullReset() { if(confirm("é‡ç½®ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
    function exportExcel() { const wb = XLSX.utils.table_to_book(document.getElementById('mainTable')); XLSX.writeFile(wb, "æˆç»©æ±‡æ€».xlsx"); }
</script>

</body>
</html>
