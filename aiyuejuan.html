
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½é˜…å·ç»ˆç«¯ - ä¸“å®¶ç”Ÿäº§ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script async src="https://docs.opencv.org/4.5.2/opencv.js" id="opencv-js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #0d6efd; --bg: #f4f7f6; }
        body { background: var(--bg); font-family: 'PingFang SC', system-ui, sans-serif; }
        .app-container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; }
        
        /* A4 ç«–ç‰ˆæ‰«ææ¡† */
        .camera-card { border: none; border-radius: 1.2rem; box-shadow: 0 10px 35px rgba(0,0,0,0.1); background: #fff; overflow: hidden; }
        .video-container { 
            position: relative; background: #000; width: 100%; 
            aspect-ratio: 210 / 297; /* ä¸¥æ ¼ A4 æ¯”ä¾‹ */
            margin: 0 auto; display: flex; align-items: center; justify-content: center;
        }
        #video { width: 100%; height: 100%; object-fit: cover; }
        
        /* çŠ¶æ€ä¸å¼¹çª— */
        #answerStatus { font-size: 0.8rem; border-radius: 20px; padding: 5px 15px; cursor: pointer; border: 1px solid transparent; }
        .status-none { background: #fff3f3; color: #d32f2f; border-color: #ffcdd2; }
        .status-ready { background: #f1f8e9; color: #388e3c; border-color: #c8e6c9; }
        
        #apiOverlay, #answerModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                                    background: rgba(0,0,0,0.8); z-index: 10000; backdrop-filter: blur(6px);
                                    justify-content: center; align-items: center; }
        .modal-box { background: #fff; padding: 2.5rem; border-radius: 1.5rem; width: 90%; max-width: 550px; }
        
        #loadingLayer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                         background: rgba(255,255,255,0.95); z-index: 9000; flex-direction: column; 
                         justify-content: center; align-items: center; }
        .table-card { border: none; border-radius: 1rem; box-shadow: 0 5px 20px rgba(0,0,0,0.05); background: #fff; padding: 1.5rem; }
    </style>
</head>
<body>

<div id="apiOverlay">
    <div class="modal-box text-center">
        <h4 class="fw-bold mb-3">ğŸ”‘ API åˆå§‹åŒ–</h4>
        <input type="password" id="apiKeyInput" class="form-control form-control-lg mb-4 text-center" placeholder="è¯·è¾“å…¥æ‚¨çš„ DashScope å¯†é’¥">
        <button class="btn btn-primary btn-lg w-100 shadow" onclick="saveKey()">ä¿å­˜å¹¶è¿›å…¥ç³»ç»Ÿ</button>
    </div>
</div>

<div id="answerModal">
    <div class="modal-box">
        <h5 class="fw-bold mb-3">ğŸ¯ æ ‡å‡†ç­”æ¡ˆä¸åˆ†å€¼é¢„è§ˆ</h5>
        <div id="answerContent" class="p-3 bg-light rounded mb-4 small" style="white-space: pre-wrap; max-height: 350px; overflow-y: auto; font-family: 'Courier New', Courier, monospace;"></div>
        <div class="d-flex gap-2">
            <button class="btn btn-secondary w-100" onclick="closeAnswerModal()">è¿”å›</button>
            <button class="btn btn-outline-danger w-100" onclick="clearAnswers()">æ¸…é™¤å¹¶é‡å½•</button>
        </div>
    </div>
</div>

<div id="loadingLayer">
    <div class="spinner-border text-primary mb-3" style="width: 3.5rem; height: 3.5rem;"></div>
    <h5 id="loadingText" class="fw-bold text-primary">æ­£åœ¨é€šè¿‡ Qwen3-VL-Flash è¯†åˆ«...</h5>
    <p class="text-muted small">è‡ªåŠ¨è®¡ç®—åˆ†å€¼å¹¶æ‰¹æ”¹æ—¥è¯­å¡«ç©º</p>
</div>

<div class="app-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1">ğŸ“– AI æ™ºèƒ½é˜…å·ç³»ç»Ÿ</h2>
            <div id="answerStatus" class="status-none" onclick="previewAnswers()">âš ï¸ å°šæœªå½•å…¥æ ‡å‡†ç­”æ¡ˆ (ç‚¹å‡»é¢„è§ˆ)</div>
        </div>
        <div>
            <button class="btn btn-outline-danger btn-sm" onclick="fullReset()">é‡ç½®å…¨éƒ¨</button>
            <button class="btn btn-success fw-bold ms-2" onclick="exportExcel()">ğŸ“Š å¯¼å‡º Excel</button>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="camera-card">
                <div class="video-container">
                    <video id="video" autoplay playsinline muted></video>
                </div>
                <div class="p-4 bg-white">
                    <div class="row g-2">
                        <div class="col-6"><button class="btn btn-warning btn-lg w-100 py-3 fw-bold" id="btnKey" onclick="handleScan('KEY')">ğŸ¯ å½•å…¥ç­”æ¡ˆ</button></div>
                        <div class="col-6"><button class="btn btn-primary btn-lg w-100 py-3 fw-bold" id="btnStudent" onclick="handleScan('STUDENT')">ğŸ“ æ‰¹æ”¹å­¦ç”Ÿ</button></div>
                    </div>
                </div>
            </div>
            <canvas id="hiddenCanvas" style="display:none;"></canvas>
        </div>

        <div class="col-lg-7">
            <div class="table-card h-100">
                <h5 class="fw-bold mb-4">é˜…å·ç»“æœæ±‡æ€» (æœ¬åœ°å®æ—¶å­˜æ¡£)</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="mainTable">
                        <thead class="table-light">
                            <tr>
                                <th>ç­çº§</th><th>å§“å</th><th>å¬åŠ›</th><th>é˜…è¯»</th><th>å®Œå½¢</th><th>å¡«ç©º</th><th class="table-warning">ä½œæ–‡</th><th>æ€»åˆ†</th><th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('hiddenCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    
    let appState = {
        apiKey: localStorage.getItem('ALI_QWEN_KEY'),
        savedConfig: JSON.parse(localStorage.getItem('SAVED_CONFIG')) || null,
        records: JSON.parse(localStorage.getItem('STUDENT_RECORDS')) || []
    };

    window.onload = () => {
        if (!appState.apiKey) document.getElementById('apiOverlay').style.display = 'flex';
        else { initApp(); renderSavedData(); }
    };

    function saveKey() {
        const val = document.getElementById('apiKeyInput').value.trim();
        if (val.startsWith('sk-')) {
            localStorage.setItem('ALI_QWEN_KEY', val);
            location.reload();
        }
    }

    async function initApp() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } 
            });
            video.srcObject = stream;
            video.onloadedmetadata = () => video.play();
            updateAnswerStatus();
        } catch (e) { alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œè¯·ç¡®ä¿ä½¿ç”¨ HTTPS ç¯å¢ƒã€‚"); }
    }

    // --- è§£å†³å¡æ­»ä¸ç²¾å‡†è¯†åˆ«çš„è°ƒåº¦é€»è¾‘ ---
    function handleScan(mode) {
        if (mode === 'STUDENT' && !appState.savedConfig) return alert("è¯·å…ˆæ‰«ææ ‡å‡†ç­”æ¡ˆå¡ï¼");
        
        const btnKey = document.getElementById('btnKey');
        const btnStudent = document.getElementById('btnStudent');
        
        // 1. ç«‹å³æ•è·å›¾åƒ (ä¸ç­‰å¾… UI æ›´æ–°ï¼Œé˜²æ­¢å¡æ­»)
        const scale = Math.min(2048 / video.videoWidth, 2048 / video.videoHeight);
        canvas.width = video.videoWidth * scale;
        canvas.height = video.videoHeight * scale;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // 2. æ›´æ–° UI çŠ¶æ€
        btnKey.disabled = true; btnStudent.disabled = true;
        document.getElementById('loadingLayer').style.display = 'flex';
        document.getElementById('loadingText').innerText = mode === 'KEY' ? "æ­£åœ¨æå–ç­”æ¡ˆä¸è®¡ç®—åˆ†å€¼..." : "æ­£åœ¨æ¯”å¯¹æ—¥è¯­å¡«ç©ºå¹¶è®¡åˆ†...";

        // 3. å»¶è¿Ÿå¤„ç†ï¼Œç»™æµè§ˆå™¨æ¸²æŸ“ Loading çš„æœºä¼š
        setTimeout(async () => {
            try {
                // æ‰§è¡Œ OpenCV å¢å¼º (å®¹é”™å¤„ç†)
                if (typeof cv !== 'undefined' && cv.Mat) {
                    try {
                        let mat = cv.imread(canvas);
                        cv.cvtColor(mat, mat, cv.COLOR_RGBA2GRAY);
                        cv.convertScaleAbs(mat, mat, 1.35, 15);
                        cv.imshow(canvas, mat);
                        mat.delete();
                    } catch (e) { console.warn("CV å¢å¼ºè·³è¿‡"); }
                }

                const base64Img = canvas.toDataURL('image/jpeg', 0.85);
                await callAI(mode, base64Img);
            } catch (err) {
                alert("è¯†åˆ«å¤±è´¥: " + err.message);
            } finally {
                document.getElementById('loadingLayer').style.display = 'none';
                btnKey.disabled = false; btnStudent.disabled = false;
                video.play();
            }
        }, 150);
    }

    async function callAI(mode, base64Img) {
    const prompt = mode === 'KEY' 
        ? `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ—¥è¯­é˜…å·ç³»ç»Ÿã€‚è¯†åˆ«æ ‡å‡†ç­”æ¡ˆå¡ï¼Œè¯†åˆ«å¡«æ¶‚æœ€é»‘çš„é€‰é¡¹ã€‚è®¡ç®—å•é¢˜å¾—åˆ†=æ€»åˆ†/é¢˜æ•°ã€‚æå–å¡«ç©ºé¢˜æ ‡å‡†ç­”æ¡ˆã€‚è¯·ä¸¥æ ¼è¿”å› JSONï¼š{"config":{"listening":{"per":0},"reading":{"per":0},"cloze":{"per":0},"filling":{"per":0}}, "answers":{"listening":{}, "reading":{}, "cloze":{}, "filling":{}}}`
        : `æ ‡å‡†ç­”æ¡ˆé…ç½®ï¼š${JSON.stringify(appState.savedConfig)}ã€‚æ‰¹æ”¹æ­¤å­¦ç”Ÿæ—¥è¯­å¡ï¼Œè¯†åˆ«å¡«æ¶‚æœ€é»‘çš„é€‰é¡¹ï¼Œæ¯”å¯¹æ—¥è¯­å¡«ç©ºã€‚è¯·ä¸¥æ ¼è¿”å› JSONï¼š{"class":"","name":"","listening":0,"reading":0,"cloze":0,"filling":0}`;

    try {
        const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${appState.apiKey}` 
            },
            body: JSON.stringify({
                model: "qwen3-vl-flash",
                messages: [{ role: "user", content: [{ type: "text", text: prompt }, { type: "image_url", image_url: { url: base64Img } }]}],
                response_format: { type: "json_object" }
            })
        });

        const resData = await response.json();

        // --- æ ¸å¿ƒä¿®å¤ï¼šå¢åŠ æ•°æ®åˆæ³•æ€§æ£€æŸ¥ ---
        if (resData.error) {
            throw new Error(`API æŠ¥é”™: ${resData.error.message || 'æœªçŸ¥é”™è¯¯'}`);
        }

        if (!resData.choices || !resData.choices[0]) {
            console.error("å¼‚å¸¸è¿”å›æ•°æ®:", resData);
            throw new Error("API è¿”å›äº†éæ ‡å‡†æ ¼å¼æ•°æ®ï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å° (F12)");
        }

        const result = JSON.parse(resData.choices[0].message.content);

        if (mode === 'KEY') {
            appState.savedConfig = result;
            localStorage.setItem('SAVED_CONFIG', JSON.stringify(result));
            updateAnswerStatus();
            previewAnswers();
        } else {
            appState.records.push(result);
            localStorage.setItem('STUDENT_RECORDS', JSON.stringify(appState.records));
            renderSavedData();
        }
    } catch (err) {
        // æ•è·å¹¶æ˜¾ç¤ºå…·ä½“é”™è¯¯ï¼Œé˜²æ­¢ä»£ç å¡æ­»
        alert("è¯†åˆ«å¤±è´¥è¯¦æƒ…: " + err.message);
        throw err; // ç»§ç»­æŠ›å‡ºä»¥ä¾¿ handleScan çš„ finally å—æ‰§è¡Œ
    }
}

    function renderSavedData() {
        const tbody = document.querySelector('#mainTable tbody');
        tbody.innerHTML = "";
        appState.records.forEach((record, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td contenteditable="true" oninput="updateRecord(\${index}, 'class', this)">\${record.class || '-'}</td>
                <td contenteditable="true" oninput="updateRecord(\${index}, 'name', this)">\${record.name || '-'}</td>
                <td contenteditable="true" class="fw-bold" oninput="updateRecord(\${index}, 'listening', this)">\${record.listening || 0}</td>
                <td contenteditable="true" class="fw-bold" oninput="updateRecord(\${index}, 'reading', this)">\${record.reading || 0}</td>
                <td contenteditable="true" class="fw-bold" oninput="updateRecord(\${index}, 'cloze', this)">\${record.cloze || 0}</td>
                <td contenteditable="true" class="fw-bold" oninput="updateRecord(\${index}, 'filling', this)">\${record.filling || 0}</td>
                <td contenteditable="true" class="table-warning fw-bold" oninput="updateRecord(\${index}, 'essay', this)">\${record.essay || 0}</td>
                <td class="total-score text-primary fw-bold">0</td>
                <td class="text-center"><button class="btn btn-link text-danger p-0 shadow-none" onclick="deleteRow(\${index})">ğŸ—‘ï¸</button></td>
            `;
            tbody.appendChild(tr);
            calculateTotal(tr);
        });
    }

    function updateRecord(index, field, el) {
        let val = (field === 'class' || field === 'name') ? el.innerText : parseFloat(el.innerText) || 0;
        appState.records[index][field] = val;
        localStorage.setItem('STUDENT_RECORDS', JSON.stringify(appState.records));
        calculateTotal(el.closest('tr'));
    }

    function calculateTotal(row) {
        let t = 0;
        row.querySelectorAll('td[contenteditable]').forEach((td, i) => { if (i >= 2) t += parseFloat(td.innerText) || 0; });
        row.querySelector('.total-score').innerText = t.toFixed(1);
    }

    function deleteRow(index) {
        if (confirm("ğŸš¨ ç¡®å®šåˆ é™¤è¯¥å­¦ç”Ÿçš„é˜…å·æˆç»©å—ï¼Ÿè¯¥æ“ä½œä¸å¯æ’¤é”€ã€‚")) {
            appState.records.splice(index, 1);
            localStorage.setItem('STUDENT_RECORDS', JSON.stringify(appState.records));
            renderSavedData();
        }
    }

    function updateAnswerStatus() {
        const s = document.getElementById('answerStatus');
        s.innerText = appState.savedConfig ? "âœ… ç­”æ¡ˆä¸åˆ†å€¼å·²å°±ç»ª (ç‚¹å‡»é¢„è§ˆ)" : "âš ï¸ å°šæœªå½•å…¥ç­”æ¡ˆ (è¯·å…ˆæ‰«æ)";
        s.className = appState.savedConfig ? "status-ready" : "status-none";
    }

    function previewAnswers() {
        if (!appState.savedConfig) return;
        document.getElementById('answerContent').innerText = JSON.stringify(appState.savedConfig, null, 4);
        document.getElementById('answerModal').style.display = 'flex';
    }

    function closeAnswerModal() { document.getElementById('answerModal').style.display = 'none'; }
    function clearAnswers() {
        if(confirm("ç¡®å®šæ¸…é™¤å½“å‰æ ‡å‡†ç­”æ¡ˆï¼Ÿæ‰¹æ”¹å‰éœ€é‡æ–°æ‰«æã€‚")) {
            appState.savedConfig = null; localStorage.removeItem('SAVED_CONFIG');
            updateAnswerStatus(); closeAnswerModal();
        }
    }

    function fullReset() {
        if (confirm("ğŸ§¹ ç¡®å®šé‡ç½®æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼ŸåŒ…æ‹¬ API Keyã€ç­”æ¡ˆå’Œæ‰€æœ‰å­¦ç”Ÿè®°å½•ã€‚")) {
            localStorage.clear(); location.reload();
        }
    }

    function exportExcel() {
        const wb = XLSX.utils.table_to_book(document.getElementById('mainTable'), {sheet: "æˆç»©å•"});
        XLSX.writeFile(wb, `æ—¥è¯­é˜…å·æ±‡æ€»_\${new Date().toLocaleDateString()}.xlsx`);
    }
</script>

</body>
</html>
