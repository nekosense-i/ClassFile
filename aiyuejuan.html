<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥è¯­é˜…å·ä¸“å®¶ç‰ˆ V5.1 - Gemini-3 é©±åŠ¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #0d6efd; --bg: #f4f7f6; }
        body { background: var(--bg); font-family: system-ui, -apple-system, sans-serif; }
        .app-container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; }
        .camera-card { border: none; border-radius: 1.2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: #fff; overflow: hidden; }
        .video-container { position: relative; background: #000; aspect-ratio: 210 / 297; display: flex; align-items: center; justify-content: center; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        .status-badge { font-size: 0.85rem; border-radius: 20px; padding: 6px 16px; cursor: pointer; border: 1px solid transparent; }
        .status-none { background: #fff1f0; color: #cf1322; border-color: #ffa39e; }
        .status-ready { background: #f6ffed; color: #389e0d; border-color: #b7eb8f; }
        #loadingLayer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 10000; flex-direction: column; justify-content: center; align-items: center; }
        .modal-box { background: #fff; padding: 2rem; border-radius: 1.2rem; width: 95%; max-width: 600px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
        #apiOverlay, #editModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 11000; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .ans-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .ans-item { border: 1px solid #dee2e6; padding: 5px; border-radius: 5px; text-align: center; }
        .ans-item input { width: 35px; text-align: center; border: none; font-weight: bold; color: #0d6efd; background: transparent; }
    </style>
</head>
<body>

<div id="apiOverlay">
    <div class="modal-box text-center">
        <h4 class="fw-bold mb-3">ğŸ”‘ é…ç½® PoloAPI ä»¤ç‰Œ</h4>
        <p class="text-muted small mb-4">è¯·è¾“å…¥ä½ åœ¨æˆªå›¾çœ‹åˆ°çš„ä»¥ sk- å¼€å¤´çš„å¯†é’¥</p>
        <input type="password" id="apiKeyInput" class="form-control form-control-lg mb-4 text-center" placeholder="sk-...">
        <button class="btn btn-primary btn-lg w-100 shadow" onclick="savePoloKey()">ä¿å­˜é…ç½®å¹¶è¿›å…¥</button>
    </div>
</div>

<div id="editModal">
    <div class="modal-box">
        <h5 class="fw-bold mb-3 d-flex justify-content-between">ğŸ¯ æ ¸å¯¹æ ‡å‡†ç­”æ¡ˆ <span class="badge bg-primary fs-6">1-50 é¢˜</span></h5>
        <div class="ans-grid" id="ansGrid"></div>
        <button class="btn btn-dark w-100 mt-4" onclick="document.getElementById('editModal').style.display='none'">ç¡®è®¤ä¿å­˜</button>
    </div>
</div>

<div id="loadingLayer">
    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
    <h5 id="loadingText" class="fw-bold text-primary">-3 æ­£åœ¨è§£æè§†è§‰æ•°æ®...</h5>
</div>

<div class="app-container">
    <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <h2 class="fw-bold mb-2">ğŸ“– æ—¥è¯­é˜…å·ä¸“å®¶ç»ˆç«¯ <small class="text-muted fs-6">gemini-3-flash</small></h2>
            <div id="answerStatus" class="status-badge status-none" onclick="openEditModal()">âš ï¸ å°šæœªå½•å…¥æ ‡ç­” (ç‚¹å‡»æ‰‹åŠ¨è¾“å…¥)</div>
        </div>
        <div>
            <button class="btn btn-outline-danger btn-sm" onclick="if(confirm('é‡ç½®æ‰€æœ‰ï¼Ÿ')){localStorage.clear();location.reload();}">é‡ç½®ç³»ç»Ÿ</button>
            <button class="btn btn-success fw-bold ms-2" onclick="exportExcel()">ğŸ“Š å¯¼å‡ºæˆç»©</button>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="camera-card">
                <div class="video-container"><video id="video" autoplay playsinline muted></video></div>
                <div class="p-4 bg-white border-top text-center">
                    <div class="row g-2">
                        <div class="col-6"><button class="btn btn-warning btn-lg w-100 py-3 fw-bold" onclick="handleScan('KEY')">ğŸ¯ æ‰«æ ‡ç­”å¡</button></div>
                        <div class="col-6"><button class="btn btn-primary btn-lg w-100 py-3 fw-bold" onclick="handleScan('STUDENT')">ğŸ“ æ‰«å­¦ç”Ÿå¡</button></div>
                    </div>
                </div>
            </div>
            <canvas id="hiddenCanvas" style="display:none;"></canvas>
        </div>
        <div class="col-lg-7">
            <div class="table-card bg-white p-4 rounded-4 shadow-sm h-100">
                <h5 class="fw-bold mb-4">é˜…å·ç»“æœæ±‡æ€» (JS ç²¾ç¡®è®¡åˆ†)</h5>
                <div class="table-responsive">
                    <table class="table table-hover text-center align-middle" id="mainTable">
                        <thead class="table-light">
                            <tr><th>ç­çº§</th><th>å§“å</th><th>å¬åŠ›(30)</th><th>é˜…è¯»(50)</th><th>å®Œå½¢(15)</th><th class="table-info">å¡«ç©º</th><th>æ€»åˆ†</th><th>-</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('hiddenCanvas');
    const ctx = canvas.getContext('2d');
    
    // æ ¹æ®æˆªå›¾å›ºå®šçš„ PoloAPI é…ç½®
    const POLO_BASE_URL = "https://xy.poloapi.com/v1beta/models/gemini-3-flash-preview-nothinking:generateContent";
    const POLO_MODEL = "gemini-3-flash-preview-nothinking";

    let appState = {
        apiKey: localStorage.getItem('POLO_KEY_GRADUATE'),
        savedKey: JSON.parse(localStorage.getItem('SAVED_KEY_FINAL')) || {}, 
        records: JSON.parse(localStorage.getItem('STUDENT_RECORDS_FINAL')) || []
    };

    window.onload = () => {
        if (!appState.apiKey) document.getElementById('apiOverlay').style.display = 'flex';
        else { initApp(); renderRecords(); }
    };

    function savePoloKey() {
        const val = document.getElementById('apiKeyInput').value.trim();
        if (val.startsWith('sk-')) { localStorage.setItem('POLO_KEY_GRADUATE', val); location.reload(); }
        else { alert("è¯·è¾“å…¥æ­£ç¡®çš„ sk- ä»¤ç‰Œï¼"); }
    }

    async function initApp() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: 1920, height: 1080 } 
            });
            video.srcObject = stream;
            updateStatusUI();
        } catch (e) { alert("ç›¸æœºå¯åŠ¨å¤±è´¥ï¼Œè¯·ä½¿ç”¨ HTTPS ç¯å¢ƒæˆ–æ£€æŸ¥æµè§ˆå™¨æƒé™ã€‚"); }
    }

    function openEditModal() {
        const grid = document.getElementById('ansGrid');
        grid.innerHTML = "";
        for (let i = 1; i <= 50; i++) {
            const div = document.createElement('div');
            div.className = 'ans-item';
            div.innerHTML = `${i}: <input type="text" maxlength="1" value="${appState.savedKey[i] || ''}" oninput="this.value=this.value.toUpperCase(); appState.savedKey[${i}]=this.value; localStorage.setItem('SAVED_KEY_FINAL', JSON.stringify(appState.savedKey)); updateStatusUI();">`;
            grid.appendChild(div);
        }
        document.getElementById('editModal').style.display = 'flex';
    }

    function updateStatusUI() {
        const s = document.getElementById('answerStatus');
        const count = Object.keys(appState.savedKey).length;
        s.innerText = count >= 50 ? `âœ… æ ‡ç­”å·²å‡†å¤‡å°±ç»ª` : `âš ï¸ æ ‡ç­”ä¸å®Œæ•´ (${count}/50)`;
        s.className = count >= 50 ? "status-badge status-ready" : "status-badge status-none";
    }

    function handleScan(mode) {
        if (mode === 'STUDENT' && Object.keys(appState.savedKey).length < 50) return alert("è¯·å…ˆå½•å…¥æ ‡ç­”å¡ï¼");
        document.getElementById('loadingLayer').style.display = 'flex';
        ctx.drawImage(video, 0, 0, canvas.width = video.videoWidth, canvas.height = video.videoHeight);
        const base64Img = canvas.toDataURL('image/jpeg', 0.85);
        setTimeout(() => callAI(mode, base64Img), 200);
    }

    async function callAI(mode, base64Img) {
        const prompt = mode === 'KEY' 
            ? "ä½ æ˜¯ä¸€ä¸ªç²¾å‡†çš„ OCR ç³»ç»Ÿã€‚ä»»åŠ¡ï¼šè¯†åˆ«ç­”é¢˜å¡ 1-50 é¢˜æ ‡å‡†ç­”æ¡ˆã€‚æ³¨æ„ï¼š1-20 é¢˜é€‰é¡¹ä»…é™ ABCï¼›21-50 é¢˜ä¸º ABCDã€‚å¿…é¡»ä»…è¿”å›çº¯ JSON æ ¼å¼ï¼š{'answers': {'1':'A', '2':'C', ...}}"
            : "ä½ æ˜¯ä¸€ä¸ªé˜…å·åŠ©æ‰‹ã€‚ä»»åŠ¡ï¼šè¯†åˆ«å­¦ç”Ÿç­”é¢˜å¡çš„å§“åã€ç­çº§å’Œ 1-50 é¢˜å¡«æ¶‚é€‰é¡¹ã€‚ä»…è¿”å›çº¯ JSONï¼š{'class':'','name':'','stu_ans':{'1':'A', '2':'B', ...}}";

        try {
            const response = await fetch(POLO_BASE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${appState.apiKey}` },
                body: JSON.stringify({
                    model: POLO_MODEL,
                    messages: [{ role: "user", content: [
                        { type: "text", text: prompt }, 
                        { type: "image_url", image_url: { url: base64Img, detail: "high" } }
                    ]}],
                    response_format: { type: "json_object" }
                })
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error?.message || "æ¥å£å¼‚å¸¸");

            const raw = data.choices[0].message.content;
            const result = JSON.parse(raw.substring(raw.indexOf('{'), raw.lastIndexOf('}') + 1));

            if (mode === 'KEY') {
                appState.savedKey = result.answers;
                localStorage.setItem('SAVED_KEY_FINAL', JSON.stringify(appState.savedKey));
                openEditModal(); updateStatusUI();
            } else {
                let scores = { listen: 0, read: 0, cloze: 0 };
                const stu = result.stu_ans || {};
                // JS æœ¬åœ°è®¡åˆ†é€»è¾‘ [cite: 16, 85, 171]
                for (let i = 1; i <= 50; i++) {
                    if (stu[i] === appState.savedKey[i]) {
                        if (i <= 20) scores.listen += 1.5;      // å¬åŠ›: 1.5/é¢˜ [cite: 16-84]
                        else if (i <= 40) scores.read += 2.5;   // é˜…è¯»: 2.5/é¢˜ [cite: 85-170]
                        else scores.cloze += 1.5;               // å®Œå½¢: 1.5/é¢˜ [cite: 171-204]
                    }
                }
                appState.records.push({ class: result.class || '-', name: result.name || '-', listen: scores.listen, read: scores.read, cloze: scores.cloze, filling: 0 });
                localStorage.setItem('STUDENT_RECORDS_FINAL', JSON.stringify(appState.records));
                renderRecords();
            }
        } catch (e) { alert("è¯†åˆ«å‡ºé”™ï¼š" + e.message); }
        finally { document.getElementById('loadingLayer').style.display = 'none'; }
    }

    function renderRecords() {
        const tbody = document.querySelector('#mainTable tbody');
        tbody.innerHTML = "";
        appState.records.forEach((r, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td contenteditable="true" onblur="updateRec(${i},'class',this)">${r.class}</td>
                <td contenteditable="true" onblur="updateRec(${i},'name',this)">${r.name}</td>
                <td>${r.listen.toFixed(1)}</td><td>${r.read.toFixed(1)}</td><td>${r.cloze.toFixed(1)}</td>
                <td contenteditable="true" class="table-info fw-bold" onblur="updateRec(${i},'filling',this)">${r.filling}</td>
                <td class="fw-bold text-primary total-score">0</td>
                <td><button class="btn btn-sm btn-link text-danger p-0 shadow-none" onclick="del(${i})">ğŸ—‘ï¸</button></td>`;
            tbody.appendChild(tr); calcRow(tr);
        });
    }

    function updateRec(i, f, el) {
        appState.records[i][f] = (f==='class'||f==='name') ? el.innerText : parseFloat(el.innerText) || 0;
        localStorage.setItem('STUDENT_RECORDS_FINAL', JSON.stringify(appState.records));
        calcRow(el.closest('tr'));
    }

    function calcRow(row) {
        const tds = row.querySelectorAll('td');
        let sum = parseFloat(tds[2].innerText) + parseFloat(tds[3].innerText) + parseFloat(tds[4].innerText) + parseFloat(tds[5].innerText);
        row.querySelector('.total-score').innerText = sum.toFixed(1);
    }

    function del(i) { if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) { appState.records.splice(i, 1); localStorage.setItem('STUDENT_RECORDS_FINAL', JSON.stringify(appState.records)); renderRecords(); } }
    function exportExcel() {
        const wb = XLSX.utils.table_to_book(document.getElementById('mainTable'), {sheet: "æˆç»©"});
        XLSX.writeFile(wb, `æ—¥è¯­æˆç»©å•_${new Date().toLocaleDateString()}.xlsx`);
    }
</script>
</body>
</html>
