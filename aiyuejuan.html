<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥è¯­é«˜è€ƒ AI é˜…å·ç»ˆç«¯ V4.5 - ç¨³å®šç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #0d6efd; --bg: #f8f9fa; }
        body { background: var(--bg); font-family: 'PingFang SC', system-ui, sans-serif; }
        .app-container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; }
        .camera-card { border: none; border-radius: 1.2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: #fff; overflow: hidden; }
        .video-container { position: relative; background: #000; width: 100%; aspect-ratio: 210 / 297; display: flex; align-items: center; justify-content: center; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        #answerStatus { font-size: 0.85rem; border-radius: 20px; padding: 6px 16px; cursor: pointer; display: inline-block; }
        .status-none { background: #fff1f0; color: #cf1322; border: 1px solid #ffa39e; }
        .status-ready { background: #f6ffed; color: #389e0d; border: 1px solid #b7eb8f; }
        #loadingLayer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9000; flex-direction: column; justify-content: center; align-items: center; }
        .modal-box { background: #fff; padding: 2.5rem; border-radius: 1.5rem; width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        #apiOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
    </style>
</head>
<body>

<div id="apiOverlay">
    <div class="modal-box text-center">
        <h4 class="fw-bold mb-3">ğŸ”‘ é…ç½® AI å¼•æ“</h4>
        <p class="text-muted small mb-4">è¯·è¾“å…¥æ‚¨çš„ DashScope (é€šä¹‰åƒé—®) API å¯†é’¥</p>
        <input type="password" id="apiKeyInput" class="form-control form-control-lg mb-4 text-center" placeholder="sk-...">
        <button class="btn btn-primary btn-lg w-100 shadow" onclick="saveKey()">ä¿å­˜å¹¶å¼€å§‹é˜…å·</button>
        <div class="mt-3 small text-muted">æç¤ºï¼šKey å°†å®‰å…¨ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°</div>
    </div>
</div>

<div id="loadingLayer">
    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
    <h5 id="loadingText" class="fw-bold text-primary">AI æ­£åœ¨æ·±åº¦æ‰«æå›¾åƒ...</h5>
</div>

<div class="app-container">
    <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <h2 class="fw-bold mb-2">ğŸ“– æ—¥è¯­é«˜è€ƒ AI é˜…å·ç»ˆç«¯</h2>
            <div id="answerStatus" class="status-none" onclick="resetKey()">âš ï¸ å°šæœªå½•å…¥æ ‡å‡†ç­”æ¡ˆ (ç‚¹æ­¤é‡ç½®)</div>
        </div>
        <div>
            <button class="btn btn-outline-danger btn-sm" onclick="fullReset()">é‡ç½®å…¨éƒ¨æ•°æ®</button>
            <button class="btn btn-success fw-bold ms-2" onclick="exportExcel()">ğŸ“Š å¯¼å‡º Excel</button>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="camera-card">
                <div class="video-container"><video id="video" autoplay playsinline muted></video></div>
                <div class="p-4 bg-white border-top text-center">
                    <div class="row g-2">
                        <div class="col-6"><button class="btn btn-warning btn-lg w-100 py-3 fw-bold" onclick="handleScan('KEY')">ğŸ¯ æ‰«æ ‡ç­”å¡</button></div>
                        <div class="col-6"><button class="btn btn-primary btn-lg w-100 py-3 fw-bold" onclick="handleScan('STUDENT')">ğŸ“ æ‰«å­¦ç”Ÿå¡</button></div>
                    </div>
                </div>
            </div>
            <canvas id="hiddenCanvas" style="display:none;"></canvas>
        </div>

        <div class="col-lg-7">
            <div class="table-card bg-white p-4 rounded-4 shadow-sm h-100">
                <h5 class="fw-bold mb-4">å®æ—¶é˜…å·æ±‡æ€»</h5>
                <div class="table-responsive">
                    <table class="table table-hover text-center align-middle" id="mainTable">
                        <thead class="table-light">
                            <tr>
                                <th>ç­çº§</th><th>å§“å</th><th>å¬åŠ›(30)</th><th>é˜…è¯»(50)</th><th>å®Œå½¢(15)</th><th class="table-info">å¡«ç©º(æ‰‹)</th><th>æ€»åˆ†</th><th>-</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('hiddenCanvas');
    const ctx = canvas.getContext('2d');
    
    let appState = {
        apiKey: localStorage.getItem('ALI_QWEN_KEY'),
        savedKey: JSON.parse(localStorage.getItem('SAVED_KEY')) || null,
        records: JSON.parse(localStorage.getItem('STUDENT_RECORDS')) || []
    };

    window.onload = () => {
        if (!appState.apiKey) {
            document.getElementById('apiOverlay').style.display = 'flex';
        } else {
            initApp();
            renderRecords();
        }
    };

    // ä¿®å¤ï¼šå¢åŠ åé¦ˆçš„ Key ä¿å­˜å‡½æ•°
    function saveKey() {
        const input = document.getElementById('apiKeyInput');
        const val = input.value.trim();
        if (val.startsWith('sk-')) {
            localStorage.setItem('ALI_QWEN_KEY', val);
            alert("âœ… API å¯†é’¥ä¿å­˜æˆåŠŸï¼ç³»ç»Ÿå°†é‡æ–°åŠ è½½ã€‚");
            location.reload();
        } else {
            alert("âŒ é”™è¯¯ï¼šAPI Key æ ¼å¼ä¸æ­£ç¡®ã€‚å¿…é¡»ä»¥ 'sk-' å¼€å¤´ã€‚");
        }
    }

    async function initApp() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } 
            });
            video.srcObject = stream;
            updateStatus();
        } catch (e) {
            alert("æ— æ³•å¯åŠ¨æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿ï¼š\\n1. ä½¿ç”¨ HTTPS ç¯å¢ƒ\\n2. å·²æˆäºˆç›¸æœºæƒé™");
        }
    }

    function handleScan(mode) {
        if (mode === 'STUDENT' && !appState.savedKey) return alert("è¯·å…ˆæ‰«æã€æ ‡å‡†ç­”æ¡ˆå¡ã€‘ï¼");
        document.getElementById('loadingLayer').style.display = 'flex';
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        const base64Img = canvas.toDataURL('image/jpeg', 0.8);

        setTimeout(() => callAI(mode, base64Img), 200);
    }

    async function callAI(mode, base64Img) {
        // æ ¸å¿ƒæç¤ºè¯ï¼šä¸¥æ ¼å¯¹åº”æ—¥è¯­é«˜è€ƒåˆ†å€¼
        const prompt = mode === 'KEY' 
            ? "ä½ æ˜¯ä¸€ä¸ªç²¾å‡†çš„é˜…å·ç³»ç»Ÿã€‚è¯·ä»ç­”é¢˜å¡è¯†åˆ«æ ‡å‡†ç­”æ¡ˆã€‚æ³¨æ„ï¼š1-20é¢˜åªæœ‰ABCä¸‰ä¸ªé€‰é¡¹ï¼›21-40é¢˜æœ‰ABCDå››ä¸ªé€‰é¡¹ï¼›41-50é¢˜æœ‰ABCDå››ä¸ªé€‰é¡¹ã€‚è¯·è¯†åˆ«å¡«æ¶‚æœ€é»‘çš„æ ¼å­ï¼Œä»…è¿”å› JSONï¼š{'answers': {'1':'A', '2':'C', ...}}"
            : `ä½ æ˜¯ä¸€ä¸ªä¸¥è°¨çš„é˜…å·è€å¸ˆã€‚å·²çŸ¥æ ‡ç­”ï¼š${JSON.stringify(appState.savedKey)}ã€‚ä»»åŠ¡ï¼šè¯†åˆ«å§“åç­çº§å’Œ1-50é¢˜å¡«æ¶‚ã€‚
               ç®—åˆ†è§„åˆ™ï¼š1-20é¢˜æ¯é¢˜1.5åˆ†ï¼›21-40é¢˜æ¯é¢˜2.5åˆ†ï¼›41-50é¢˜æ¯é¢˜1.5åˆ†ã€‚
               ä»…è¿”å› JSONï¼š{'class':'','name':'','listening':0,'reading':0,'cloze':0}`;

        try {
            const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json', 
                    'Authorization': `Bearer ${appState.apiKey.trim()}` 
                },
                body: JSON.stringify({
                    model: "qwen-vl-plus", 
                    messages: [{ role: "user", content: [{ type: "text", text: prompt }, { type: "image_url", image_url: { url: base64Img } }]}],
                    response_format: { type: "json_object" }
                })
            });

            const data = await response.json();

            if (!response.ok) {
                // æ•è· 401 ç­‰æˆæƒé”™è¯¯
                throw new Error(data.message || `API è¿”å›é”™è¯¯ (${response.status})`);
            }

            if (!data.choices || !data.choices[0]) throw new Error("AI å“åº”æ ¼å¼ä¸å®Œæ•´");

            const result = JSON.parse(data.choices[0].message.content);

            if (mode === 'KEY') {
                appState.savedKey = result.answers;
                localStorage.setItem('SAVED_KEY', JSON.stringify(result.answers));
                updateStatus();
                alert("ğŸ¯ æ ‡å‡†ç­”æ¡ˆå½•å…¥æˆåŠŸï¼");
            } else {
                appState.records.push({
                    class: result.class || '-', name: result.name || '-',
                    listening: result.listening || 0, reading: result.reading || 0, cloze: result.cloze || 0,
                    filling: 0 // å¡«ç©ºç”±æ•™å¸ˆæ‰‹å½•
                });
                localStorage.setItem('STUDENT_RECORDS', JSON.stringify(appState.records));
                renderRecords();
            }
        } catch (e) {
            console.error(e);
            alert("âŒ è¯†åˆ«å¤±è´¥ï¼š" + e.message + "\\nè¯·æ£€æŸ¥ Key æ˜¯å¦æœ‰æ•ˆã€ä½™é¢æ˜¯å¦å……è£•ã€‚");
        } finally {
            document.getElementById('loadingLayer').style.display = 'none';
        }
    }

    function renderRecords() {
        const tbody = document.querySelector('#mainTable tbody');
        tbody.innerHTML = "";
        appState.records.forEach((r, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td contenteditable="true" onblur="updateVal(${i},'class',this)">${r.class}</td>
                <td contenteditable="true" onblur="updateVal(${i},'name',this)">${r.name}</td>
                <td>${r.listening}</td><td>${r.reading}</td><td>${r.cloze}</td>
                <td contenteditable="true" class="table-info fw-bold" onblur="updateVal(${i},'filling',this)">${r.filling}</td>
                <td class="fw-bold text-primary total-score">0</td>
                <td><button class="btn btn-sm btn-link text-danger p-0" onclick="del(${i})">ğŸ—‘ï¸</button></td>
            `;
            tbody.appendChild(tr);
            calcTotal(tr);
        });
    }

    function updateVal(i, f, el) {
        appState.records[i][f] = (f==='class'||f==='name') ? el.innerText : parseFloat(el.innerText) || 0;
        localStorage.setItem('STUDENT_RECORDS', JSON.stringify(appState.records));
        calcTotal(el.closest('tr'));
    }

    function calcTotal(row) {
        const tds = row.querySelectorAll('td');
        let sum = parseFloat(tds[2].innerText) + parseFloat(tds[3].innerText) + parseFloat(tds[4].innerText) + parseFloat(tds[5].innerText);
        row.querySelector('.total-score').innerText = sum.toFixed(1);
    }

    function updateStatus() {
        const s = document.getElementById('answerStatus');
        s.innerText = appState.savedKey ? "âœ… æ ‡ç­”å·²å°±ç»ª (å¯æ‰¹æ”¹å­¦ç”Ÿ)" : "âš ï¸ è¯·å…ˆæ‰«ææ ‡ç­”å¡";
        s.className = appState.savedKey ? "status-ready" : "status-none";
    }

    function del(i) { if(confirm("ç¡®å®šåˆ é™¤è¯¥è®°å½•ï¼Ÿ")) { appState.records.splice(i, 1); localStorage.setItem('STUDENT_RECORDS', JSON.stringify(appState.records)); renderRecords(); } }
    function fullReset() { if(confirm("ğŸš¨ è­¦å‘Šï¼šå°†æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬ API Keyï¼‰ã€‚ç¡®å®šï¼Ÿ")) { localStorage.clear(); location.reload(); } }
    function resetKey() { if(confirm("æ˜¯å¦é‡æ–°æ‰«ææ ‡å‡†ç­”æ¡ˆå¡ï¼Ÿ")) { localStorage.removeItem('SAVED_KEY'); location.reload(); } }

    function exportExcel() {
        const wb = XLSX.utils.table_to_book(document.getElementById('mainTable'), {sheet: "æˆç»©å•"});
        XLSX.writeFile(wb, `æ—¥è¯­é˜…å·æ±‡æ€»_${new Date().toLocaleDateString()}.xlsx`);
    }
</script>
</body>
</html>
