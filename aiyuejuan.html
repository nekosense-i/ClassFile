
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥è¯­é«˜è€ƒ AI é˜…å·ç»ˆç«¯ - æ•™å¸ˆä¸“ç”¨ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script async src="https://docs.opencv.org/4.5.2/opencv.js" id="opencv-js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #0d6efd; --bg: #f8f9fa; }
        body { background: var(--bg); font-family: 'PingFang SC', system-ui, sans-serif; }
        .app-container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; }
        
        /* A4 æ¯”ä¾‹ç›¸æœºæ¡† */
        .camera-card { border: none; border-radius: 1.2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.08); background: #fff; overflow: hidden; }
        .video-container { 
            position: relative; background: #000; width: 100%; 
            aspect-ratio: 210 / 297; 
            margin: 0 auto; display: flex; align-items: center; justify-content: center;
        }
        #video { width: 100%; height: 100%; object-fit: cover; }
        
        /* çŠ¶æ€æ ‡è®° */
        #answerStatus { font-size: 0.85rem; border-radius: 20px; padding: 6px 16px; cursor: pointer; display: inline-block; transition: all 0.3s; }
        .status-none { background: #fff1f0; color: #cf1322; border: 1px solid #ffa39e; }
        .status-ready { background: #f6ffed; color: #389e0d; border: 1px solid #b7eb8f; }
        
        .modal-box { background: #fff; padding: 2rem; border-radius: 1.2rem; width: 90%; max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        #apiOverlay, #answerModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                                    background: rgba(0,0,0,0.7); z-index: 10000; backdrop-filter: blur(4px);
                                    justify-content: center; align-items: center; }
        
        #loadingLayer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                         background: rgba(255,255,255,0.9); z-index: 9000; flex-direction: column; 
                         justify-content: center; align-items: center; }
        .table-card { border: none; border-radius: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); background: #fff; padding: 1.5rem; }
        .total-score { font-size: 1.2rem; color: #0d6efd; }
    </style>
</head>
<body>

<div id="apiOverlay">
    <div class="modal-box text-center">
        <h4 class="fw-bold mb-3">ğŸ”‘ è¿æ¥ DashScope</h4>
        <p class="text-muted small mb-4">è¯·è¾“å…¥é€šä¹‰åƒé—® (Qwen-VL) çš„ API å¯†é’¥ä»¥å¯åŠ¨ AI è§†è§‰èƒ½åŠ›</p>
        <input type="password" id="apiKeyInput" class="form-control form-control-lg mb-4 text-center" placeholder="sk-xxxx...">
        <button class="btn btn-primary btn-lg w-100 shadow-sm" onclick="saveKey()">ä¿å­˜å¹¶åˆå§‹åŒ–</button>
    </div>
</div>

<div id="answerModal">
    <div class="modal-box">
        <h5 class="fw-bold mb-3">ğŸ¯ æ ‡å‡†ç­”æ¡ˆé…ç½®</h5>
        <div id="answerContent" class="p-3 bg-light rounded mb-4 small" style="white-space: pre-wrap; max-height: 300px; overflow-y: auto; font-family: monospace;"></div>
        <div class="d-flex gap-2">
            <button class="btn btn-secondary w-100" onclick="closeAnswerModal()">è¿”å›</button>
            <button class="btn btn-outline-danger w-100" onclick="clearAnswers()">æ¸…é™¤è®°å½•</button>
        </div>
    </div>
</div>

<div id="loadingLayer">
    <div class="spinner-grow text-primary mb-3"></div>
    <h5 id="loadingText" class="fw-bold text-primary">AI æ­£åœ¨æ‰«æå·é¢...</h5>
</div>

<div class="app-container">
    <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <h2 class="fw-bold mb-2">ğŸ“– æ—¥è¯­é˜…å·ç»ˆç«¯ <span class="badge bg-primary fs-6">V4.0 Pro</span></h2>
            <div id="answerStatus" class="status-none" onclick="previewAnswers()">âš ï¸ å°šæœªå½•å…¥æ ‡å‡†ç­”æ¡ˆ (ç‚¹å‡»é…ç½®)</div>
        </div>
        <div>
            <button class="btn btn-outline-secondary btn-sm" onclick="fullReset()">å…¨éƒ¨æ¸…ç©º</button>
            <button class="btn btn-success fw-bold ms-2" onclick="exportExcel()">ğŸ“Š å¯¼å‡ºæˆç»©å•</button>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="camera-card">
                <div class="video-container">
                    <video id="video" autoplay playsinline muted></video>
                </div>
                <div class="p-4 bg-white border-top">
                    <div class="row g-2">
                        <div class="col-6"><button class="btn btn-warning btn-lg w-100 py-3 fw-bold" id="btnKey" onclick="handleScan('KEY')">ğŸ¯ æ‰«æ ‡å‡†ç­”æ¡ˆ</button></div>
                        <div class="col-6"><button class="btn btn-primary btn-lg w-100 py-3 fw-bold" id="btnStudent" onclick="handleScan('STUDENT')">ğŸ“ æ‰«å­¦ç”Ÿå¡</button></div>
                    </div>
                    <p class="text-center text-muted mt-3 mb-0 small">æç¤ºï¼šè¯·ç¡®ä¿ç­”é¢˜å¡å››ä¸ªè§’éƒ½åœ¨ç”»é¢å†…</p>
                </div>
            </div>
            <canvas id="hiddenCanvas" style="display:none;"></canvas>
        </div>

        <div class="col-lg-7">
            <div class="table-card h-100">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold m-0">é˜…å·ç»Ÿè®¡æ•°æ®</h5>
                    <span class="text-muted small">ç‚¹å‡»åˆ†å€¼å¯ç›´æ¥æ‰‹åŠ¨ä¿®æ”¹</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle text-center" id="mainTable">
                        <thead class="table-light">
                            <tr>
                                <th>ç­çº§</th><th>å§“å</th><th>å¬åŠ›(30)</th><th>é˜…è¯»(50)</th><th>å®Œå½¢(15)</th><th class="table-info">å¡«ç©º(æ‰‹æ‰¹)</th><th class="table-warning">ä½œæ–‡</th><th>æ€»åˆ†</th><th>-</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('hiddenCanvas');
    const ctx = canvas.getContext('2d');
    
    let appState = {
        apiKey: localStorage.getItem('ALI_QWEN_KEY'),
        savedKey: JSON.parse(localStorage.getItem('SAVED_ANSWER_KEY')) || null,
        records: JSON.parse(localStorage.getItem('STUDENT_RECORDS')) || []
    };

    window.onload = () => {
        if (!appState.apiKey) document.getElementById('apiOverlay').style.display = 'flex';
        else { initApp(); renderRecords(); }
    };

    function saveKey() {
        const val = document.getElementById('apiKeyInput').value.trim();
        if (val.startsWith('sk-')) {
            localStorage.setItem('ALI_QWEN_KEY', val);
            location.reload();
        } else { alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ DashScope sk- å¯†é’¥"); }
    }

    async function initApp() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } 
            });
            video.srcObject = stream;
            updateAnswerStatus();
        } catch (e) { alert("ç›¸æœºæƒé™å¼€å¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¾ç½®ã€‚"); }
    }

    function handleScan(mode) {
        if (mode === 'STUDENT' && !appState.savedKey) return alert("è¯·å…ˆæ‰«æã€æ ‡å‡†ç­”æ¡ˆå¡ã€‘ï¼");
        
        document.getElementById('loadingLayer').style.display = 'flex';
        document.getElementById('loadingText').innerText = mode === 'KEY' ? "æ­£åœ¨è¯†åˆ«æ ‡å‡†ç­”æ¡ˆ..." : "æ­£åœ¨æ™ºèƒ½æ‰¹æ”¹å®¢è§‚é¢˜...";

        // æ‹ç…§é¢„å¤„ç†
        const scale = 1.5; // æé«˜åˆ†è¾¨ç‡ä»¥çœ‹æ¸…å¡«æ¶‚
        canvas.width = video.videoWidth * scale;
        canvas.height = video.videoHeight * scale;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // æ¨¡æ‹Ÿä¸€å¸§å»¶è¿Ÿï¼Œç¡®ä¿ UI æ¸²æŸ“
        setTimeout(async () => {
            const base64Img = canvas.toDataURL('image/jpeg', 0.9);
            await callAI(mode, base64Img);
        }, 100);
    }

    async function callAI(mode, base64Img) {
        // --- æ ¸å¿ƒä¼˜åŒ–æç¤ºè¯ï¼šæ³¨å…¥é¢˜å‹é€»è¾‘ ---
        const prompt = mode === 'KEY' 
            ? `ä½ æ˜¯ä¸€ä¸ªæ ‡å‡†åŒ–çš„é˜…å·ä¸“å®¶ã€‚è¯·åˆ†æè¿™å¼ æ—¥è¯­é«˜è€ƒç­”é¢˜å¡ï¼ˆç¬¬ä¸€é¡µï¼‰ï¼Œæå–æ ‡å‡†ç­”æ¡ˆã€‚
               è¯†åˆ«è§„åˆ™ï¼š
               1. é¢˜å· 1-20ï¼ˆå¬åŠ›ï¼‰ï¼šé€‰é¡¹ä»…é™ [A, B, C]ã€‚
               2. é¢˜å· 21-40ï¼ˆé˜…è¯»ï¼‰ï¼šé€‰é¡¹ä¸º [A, B, C, D]ã€‚
               3. é¢˜å· 41-50ï¼ˆå®Œå½¢ï¼‰ï¼šé€‰é¡¹ä¸º [A, B, C, D]ã€‚
               è¯·è¯†åˆ«æ¯ä¸ªé¢˜å·å¯¹åº”å¡«æ¶‚æœ€é»‘çš„é€‰é¡¹ã€‚
               è¾“å‡ºæ ¼å¼ï¼ˆJSONï¼‰ï¼š{"answers": {"1":"A", "2":"B", ..., "50":"D"}}`
            : `ä½ æ˜¯ä¸€ä¸ªç²¾å‡†çš„é˜…å·åŠ©æ‰‹ã€‚å·²çŸ¥æ ‡å‡†ç­”æ¡ˆä¸ºï¼š\${JSON.stringify(appState.savedKey.answers)}ã€‚
               ä»»åŠ¡ï¼š
               1. è¯†åˆ«å›¾åƒå·¦ä¸Šè§’çš„ç­çº§å’Œå§“åã€‚
               2. è¯†åˆ«é¢˜å· 1-50 çš„å­¦ç”Ÿå¡«æ¶‚ç»“æœã€‚
               3. åˆ¤å®šé€»è¾‘ï¼šå¡«æ¶‚æœ€é»‘è€…æœ‰æ•ˆï¼›è‹¥æœªæ¶‚æ ‡è®°ä¸º"N"ï¼›è‹¥å¤šæ¶‚æ ‡è®°ä¸º"X"ã€‚
               4. ç®—åˆ†è§„åˆ™ï¼š
                  - 1-20é¢˜ï¼šæ¯é¢˜1.5åˆ†ã€‚
                  - 21-40é¢˜ï¼šæ¯é¢˜2.5åˆ†ã€‚
                  - 41-50é¢˜ï¼šæ¯é¢˜1.5åˆ†ã€‚
               æ³¨æ„ï¼šä¸éœ€è¦è¯†åˆ« 51 é¢˜åŠä¹‹åçš„å¡«ç©ºé¢˜ã€‚
               è¾“å‡ºæ ¼å¼ï¼ˆJSONï¼‰ï¼š{"class":"xx", "name":"xx", "score_listening":0.0, "score_reading":0.0, "score_cloze":0.0}`;

        try {
            const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer \${appState.apiKey}` },
                body: JSON.stringify({
                    model: "qwen3-vl-flash", // å»ºè®®ä½¿ç”¨ max æˆ– flash è§†è§‰ç‰ˆ
                    messages: [{ role: "user", content: [{ type: "text", text: prompt }, { type: "image_url", image_url: { url: base64Img } }]}],
                    response_format: { type: "json_object" }
                })
            });

            const data = await response.json();
            const result = JSON.parse(data.choices[0].message.content);

            if (mode === 'KEY') {
                appState.savedKey = result;
                localStorage.setItem('SAVED_ANSWER_KEY', JSON.stringify(result));
                updateAnswerStatus();
                alert("æ ‡å‡†ç­”æ¡ˆå½•å…¥æˆåŠŸï¼");
            } else {
                appState.records.push({
                    class: result.class,
                    name: result.name,
                    listening: result.score_listening || 0,
                    reading: result.score_reading || 0,
                    cloze: result.score_cloze || 0,
                    filling: 0, // å¡«ç©ºé¢˜é»˜è®¤ä¸º0ï¼Œç­‰å¾…æ‰‹æ‰¹
                    essay: 0
                });
                localStorage.setItem('STUDENT_RECORDS', JSON.stringify(appState.records));
                renderRecords();
            }
        } catch (e) {
            console.error(e);
            alert("è¯†åˆ«å‡ºé”™ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– API ä½™é¢ã€‚");
        } finally {
            document.getElementById('loadingLayer').style.display = 'none';
        }
    }

    function renderRecords() {
        const tbody = document.querySelector('#mainTable tbody');
        tbody.innerHTML = "";
        appState.records.forEach((r, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td contenteditable="true" onblur="updateField(\${i}, 'class', this)">\${r.class || '-'}</td>
                <td contenteditable="true" onblur="updateField(\${i}, 'name', this)">\${r.name || '-'}</td>
                <td contenteditable="true" onblur="updateField(\${i}, 'listening', this)">\${r.listening}</td>
                <td contenteditable="true" onblur="updateField(\${i}, 'reading', this)">\${r.reading}</td>
                <td contenteditable="true" onblur="updateField(\${i}, 'cloze', this)">\${r.cloze}</td>
                <td contenteditable="true" class="table-info fw-bold" onblur="updateField(\${i}, 'filling', this)">\${r.filling}</td>
                <td contenteditable="true" class="table-warning fw-bold" onblur="updateField(\${i}, 'essay', this)">\${r.essay}</td>
                <td class="total-score fw-bold">0</td>
                <td><button class="btn btn-sm btn-link text-danger p-0" onclick="delRecord(\${i})">âŒ</button></td>
            `;
            tbody.appendChild(tr);
            calcRowTotal(tr);
        });
    }

    function updateField(idx, field, el) {
        const val = (field === 'class' || field === 'name') ? el.innerText : parseFloat(el.innerText) || 0;
        appState.records[idx][field] = val;
        localStorage.setItem('STUDENT_RECORDS', JSON.stringify(appState.records));
        calcRowTotal(el.closest('tr'));
    }

    function calcRowTotal(row) {
        let sum = 0;
        row.querySelectorAll('td[contenteditable]').forEach((td, i) => { if(i>=2) sum += parseFloat(td.innerText) || 0; });
        row.querySelector('.total-score').innerText = sum.toFixed(1);
    }

    function updateAnswerStatus() {
        const s = document.getElementById('answerStatus');
        s.innerText = appState.savedKey ? "âœ… æ ‡å‡†ç­”æ¡ˆå·²å½•å…¥" : "âš ï¸ è¯·å…ˆæ‰«ææ ‡å‡†ç­”æ¡ˆ";
        s.className = appState.savedKey ? "status-ready" : "status-none";
    }

    function previewAnswers() {
        if (!appState.savedKey) return;
        document.getElementById('answerContent').innerText = JSON.stringify(appState.savedKey, null, 2);
        document.getElementById('answerModal').style.display = 'flex';
    }

    function closeAnswerModal() { document.getElementById('answerModal').style.display = 'none'; }
    function clearAnswers() { if(confirm("ç¡®å®šæ¸…ç©ºæ ‡å‡†ç­”æ¡ˆï¼Ÿ")) { localStorage.removeItem('SAVED_ANSWER_KEY'); location.reload(); } }
    function delRecord(i) { if(confirm("ç¡®å®šåˆ é™¤è¯¥è®°å½•ï¼Ÿ")) { appState.records.splice(i, 1); localStorage.setItem('STUDENT_RECORDS', JSON.stringify(appState.records)); renderRecords(); } }
    function fullReset() { if(confirm("ç¡®å®šé‡ç½®æ‰€æœ‰æ•°æ®ï¼Ÿ")) { localStorage.clear(); location.reload(); } }

    function exportExcel() {
        const wb = XLSX.utils.table_to_book(document.getElementById('mainTable'), {sheet: "æ—¥è¯­æˆç»©å•"});
        XLSX.writeFile(wb, `é˜…å·æ±‡æ€»_\${new Date().toLocaleDateString()}.xlsx`);
    }
</script>

</body>
</html>
